/**
    * Earthstar v10.0.1
    * https://earthstar-project.org
    *
    * This source code is licensed under the LGPL-3.0 license. 
  */
  
  
var ps=Object.defineProperty;var dr=(r,e)=>{for(var t in e)ps(r,t,{get:e[t],enumerable:!0})};var R=class extends Error{constructor(e){super(e||""),this.name="EarthstarError"}},m=class extends R{constructor(e){super(e||"Validation error"),this.name="ValidationError"}},v=class extends R{constructor(e){super(e||"a Replica or ReplicaDriver was used after being closed"),this.name="ReplicaIsClosedError"}},ye=class extends R{constructor(e){super(e||"a ReplicaCache was used after being closed"),this.name="ReplicaCacheIsClosedError"}},zr=class extends R{constructor(e){super(e||"network error"),this.name="NetworkError"}},Gr=class extends R{constructor(e){super(e||"timeout error"),this.name="TimeoutError"}},Jr=class extends R{constructor(e){super(e||"connection refused"),this.name="ConnectionRefused"}},Zr=class extends R{constructor(e){super(e||"not implemented yet"),this.name="NotImplementedError"}},ce=class extends R{constructor(e){super(e||"Not supported"),this.name="NotSupportedError"}};function w(r){return r instanceof R}function hr(r){return!(r instanceof R)}function _e(r,e){if(r===e)return!0;if(!r||!e)return!1;var t=r.length;if(e.length!==t)return!1;for(var n=0;n<t;n++)if(r[n]!==e[n])return!1;return!0}function we(r,e){if(r===e)return!0;if(!r||!e)return!1;var t=Object.keys(r),n=Object.keys(e),s=t.length;if(n.length!==s)return!1;for(var a=0;a<s;a++){var i=t[a];if(r[i]!==e[i]||!Object.prototype.hasOwnProperty.call(e,i))return!1}return!0}var fs=Object.create,Xr=Object.defineProperty,ms=Object.getOwnPropertyDescriptor,gs=Object.getOwnPropertyNames,ys=Object.getPrototypeOf,ws=Object.prototype.hasOwnProperty,bs=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Ts=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of gs(e))!ws.call(r,s)&&s!==t&&Xr(r,s,{get:()=>e[s],enumerable:!(n=ms(e,s))||n.enumerable});return r},vs=(r,e,t)=>(t=r!=null?fs(ys(r)):{},Ts(e||!r||!r.__esModule?Xr(t,"default",{value:r,enumerable:!0}):t,r)),As=bs((r,e)=>{"use strict";e.exports=function(t,n){n||(n={}),typeof n=="function"&&(n={cmp:n});var s=typeof n.cycles=="boolean"?n.cycles:!1,a=n.cmp&&function(o){return function(c){return function(l,h){var d={key:l,value:c[l]},u={key:h,value:c[h]};return o(d,u)}}}(n.cmp),i=[];return function o(c){if(c&&c.toJSON&&typeof c.toJSON=="function"&&(c=c.toJSON()),c!==void 0){if(typeof c=="number")return isFinite(c)?""+c:"null";if(typeof c!="object")return JSON.stringify(c);var l,h;if(Array.isArray(c)){for(h="[",l=0;l<c.length;l++)l&&(h+=","),h+=o(c[l])||"null";return h+"]"}if(c===null)return"null";if(i.indexOf(c)!==-1){if(s)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var d=i.push(c)-1,u=Object.keys(c).sort(a&&a(c));for(h="",l=0;l<u.length;l++){var p=u[l],f=o(c[p]);!f||(h&&(h+=","),h+=JSON.stringify(p)+":"+f)}return i.splice(d,1),"{"+h+"}"}}(t)}}),Ss=vs(As()),{default:Yr,...Ds}=Ss,kt=Yr!==void 0?Yr:Ds;var $e={};dr($e,{base16:()=>Ls,base32:()=>Ms,base32hex:()=>_s,base64:()=>Ns,base64url:()=>Os,codec:()=>Us,default:()=>tn});var xs=Object.create,en=Object.defineProperty,Es=Object.getOwnPropertyDescriptor,Bs=Object.getOwnPropertyNames,ks=Object.getPrototypeOf,Is=Object.prototype.hasOwnProperty,Cs=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Fs=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Bs(e))!Is.call(r,s)&&s!==t&&en(r,s,{get:()=>e[s],enumerable:!(n=Es(e,s))||n.enumerable});return r},Rs=(r,e,t)=>(t=r!=null?xs(ks(r)):{},Fs(e||!r||!r.__esModule?en(t,"default",{value:r,enumerable:!0}):t,r)),Ps=Cs(r=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0});function e(f,g,A){var E;if(A===void 0&&(A={}),!g.codes){g.codes={};for(var _=0;_<g.chars.length;++_)g.codes[g.chars[_]]=_}if(!A.loose&&f.length*g.bits&7)throw new SyntaxError("Invalid padding");for(var b=f.length;f[b-1]==="=";)if(--b,!A.loose&&!((f.length-b)*g.bits&7))throw new SyntaxError("Invalid padding");for(var S=new((E=A.out)!=null?E:Uint8Array)(b*g.bits/8|0),D=0,B=0,k=0,F=0;F<b;++F){var N=g.codes[f[F]];if(N===void 0)throw new SyntaxError("Invalid character "+f[F]);B=B<<g.bits|N,D+=g.bits,D>=8&&(D-=8,S[k++]=255&B>>D)}if(D>=g.bits||255&B<<8-D)throw new SyntaxError("Unexpected end of data");return S}function t(f,g,A){A===void 0&&(A={});for(var E=A,_=E.pad,b=_===void 0?!0:_,S=(1<<g.bits)-1,D="",B=0,k=0,F=0;F<f.length;++F)for(k=k<<8|255&f[F],B+=8;B>g.bits;)B-=g.bits,D+=g.chars[S&k>>B];if(B&&(D+=g.chars[S&k<<g.bits-B]),b)for(;D.length*g.bits&7;)D+="=";return D}var n={chars:"0123456789ABCDEF",bits:4},s={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bits:5},a={chars:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bits:5},i={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bits:6},o={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bits:6},c={parse:function(f,g){return e(f.toUpperCase(),n,g)},stringify:function(f,g){return t(f,n,g)}},l={parse:function(f,g){return g===void 0&&(g={}),e(g.loose?f.toUpperCase().replace(/0/g,"O").replace(/1/g,"L").replace(/8/g,"B"):f,s,g)},stringify:function(f,g){return t(f,s,g)}},h={parse:function(f,g){return e(f,a,g)},stringify:function(f,g){return t(f,a,g)}},d={parse:function(f,g){return e(f,i,g)},stringify:function(f,g){return t(f,i,g)}},u={parse:function(f,g){return e(f,o,g)},stringify:function(f,g){return t(f,o,g)}},p={parse:e,stringify:t};r.base16=c,r.base32=l,r.base32hex=h,r.base64=d,r.base64url=u,r.codec=p}),Ne=Rs(Ps(),1),Ls=Ne.default.base16,Ms=Ne.default.base32,_s=Ne.default.base32hex,Ns=Ne.default.base64,Os=Ne.default.base64url,Us=Ne.default.codec,tn=Ne.default;var It={};dr(It,{Hash:()=>Js,__esModule:()=>Gs,createHash:()=>Zs,default:()=>an});var Vs=Object.create,nn=Object.defineProperty,Ks=Object.getOwnPropertyDescriptor,qs=Object.getOwnPropertyNames,Ws=Object.getPrototypeOf,js=Object.prototype.hasOwnProperty,Qs=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),$s=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of qs(e))!js.call(r,s)&&s!==t&&nn(r,s,{get:()=>e[s],enumerable:!(n=Ks(e,s))||n.enumerable});return r},Hs=(r,e,t)=>(t=r!=null?Vs(Ws(r)):{},$s(e||!r||!r.__esModule?nn(t,"default",{value:r,enumerable:!0}):t,r)),zs=Qs(r=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.Hash=r.createHash=void 0;var e=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],t={sha256:1};function n(b){if(b&&!t[b]&&!t[b.toLowerCase()])throw new Error("Digest method not supported");return new s}r.createHash=n;var s=class{constructor(){this.A=1779033703,this.B=-1150833019,this.C=1013904242,this.D=-1521486534,this.E=1359893119,this.F=-1694144372,this.G=528734635,this.H=1541459225,this._size=0,this._sp=0,(!i||o>=8e3)&&(i=new ArrayBuffer(8e3),o=0),this._byte=new Uint8Array(i,o,80),this._word=new Int32Array(i,o,20),o+=80}update(b){if(typeof b=="string")return this._utf8(b);if(b==null)throw new TypeError("Invalid type: "+typeof b);let S=b.byteOffset,D=b.byteLength,B=D/64|0,k=0;if(B&&!(S&3)&&!(this._size%64)){let F=new Int32Array(b.buffer,S,B*16);for(;B--;)this._int32(F,k>>2),k+=64;this._size+=k}if(b.BYTES_PER_ELEMENT!==1&&b.buffer){let F=new Uint8Array(b.buffer,S+k,D-k);return this._uint8(F)}return k===D?this:this._uint8(b,k)}_uint8(b,S){let{_byte:D,_word:B}=this,k=b.length;for(S=S|0;S<k;){let F=this._size%64,N=F;for(;S<k&&N<64;)D[N++]=b[S++];N>=64&&this._int32(B),this._size+=N-F}return this}_utf8(b){let{_byte:S,_word:D}=this,B=b.length,k=this._sp;for(let F=0;F<B;){let N=this._size%64,O=N;for(;F<B&&O<64;){let M=b.charCodeAt(F++)|0;M<128?S[O++]=M:M<2048?(S[O++]=192|M>>>6,S[O++]=128|M&63):M<55296||M>57343?(S[O++]=224|M>>>12,S[O++]=128|M>>>6&63,S[O++]=128|M&63):k?(M=((k&1023)<<10)+(M&1023)+65536,S[O++]=240|M>>>18,S[O++]=128|M>>>12&63,S[O++]=128|M>>>6&63,S[O++]=128|M&63,k=0):k=M}O>=64&&(this._int32(D),D[0]=D[16]),this._size+=O-N}return this._sp=k,this}_int32(b,S){let{A:D,B,C:k,D:F,E:N,F:O,G:M,H:oe}=this,Y=0;for(S=S|0;Y<16;)a[Y++]=d(b[S++]);for(Y=16;Y<64;Y++)a[Y]=E(a[Y-2])+a[Y-7]+A(a[Y-15])+a[Y-16]|0;for(Y=0;Y<64;Y++){let Hr=oe+g(N)+u(N,O,M)+e[Y]+a[Y]|0,hs=f(D)+p(D,B,k)|0;oe=M,M=O,O=N,N=F+Hr|0,F=k,k=B,B=D,D=Hr+hs|0}this.A=D+this.A|0,this.B=B+this.B|0,this.C=k+this.C|0,this.D=F+this.D|0,this.E=N+this.E|0,this.F=O+this.F|0,this.G=M+this.G|0,this.H=oe+this.H|0}digest(b){let{_byte:S,_word:D}=this,B=this._size%64|0;for(S[B++]=128;B&3;)S[B++]=0;if(B>>=2,B>14){for(;B<16;)D[B++]=0;B=0,this._int32(D)}for(;B<16;)D[B++]=0;let k=this._size*8,F=(k&4294967295)>>>0,N=(k-F)/4294967296;return N&&(D[14]=d(N)),F&&(D[15]=d(F)),this._int32(D),b==="hex"?this._hex():this._bin()}_hex(){let{A:b,B:S,C:D,D:B,E:k,F,G:N,H:O}=this;return c(b)+c(S)+c(D)+c(B)+c(k)+c(F)+c(N)+c(O)}_bin(){let{A:b,B:S,C:D,D:B,E:k,F,G:N,H:O,_byte:M,_word:oe}=this;return oe[0]=d(b),oe[1]=d(S),oe[2]=d(D),oe[3]=d(B),oe[4]=d(k),oe[5]=d(F),oe[6]=d(N),oe[7]=d(O),M.slice(0,32)}};r.Hash=s;var a=new Int32Array(64),i,o=0,c=b=>(b+4294967296).toString(16).substr(-8),l=b=>b<<24&4278190080|b<<8&16711680|b>>8&65280|b>>24&255,h=b=>b,d=_()?h:l,u=(b,S,D)=>D^b&(S^D),p=(b,S,D)=>b&S|D&(b|S),f=b=>(b>>>2|b<<30)^(b>>>13|b<<19)^(b>>>22|b<<10),g=b=>(b>>>6|b<<26)^(b>>>11|b<<21)^(b>>>25|b<<7),A=b=>(b>>>7|b<<25)^(b>>>18|b<<14)^b>>>3,E=b=>(b>>>17|b<<15)^(b>>>19|b<<13)^b>>>10;function _(){return new Uint8Array(new Uint16Array([65279]).buffer)[0]===254}}),sn=Hs(zs()),Gs=!0,{Hash:Js,createHash:Zs}=sn,{default:rn,...Ys}=sn,an=rn!==void 0?rn:Ys;var Ve={};dr(Ve,{CURVE:()=>P,ExtendedPoint:()=>W,Point:()=>V,RistrettoPoint:()=>Oe,getPublicKey:()=>fn,sign:()=>mn,utils:()=>dt,verify:()=>gn});var q=BigInt(0),I=BigInt(1),X=BigInt(2),un=BigInt(255),on=X**BigInt(252)+BigInt("27742317777372353535851937790883648493"),P={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),P:X**un-BigInt(19),l:on,n:on,h:BigInt(8),Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960")};var dn=X**BigInt(256),ct=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),fi=BigInt("6853475219497561581579357271197624642482790079785650197046958215289687604742"),Xs=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),ea=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),ta=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),ra=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952"),Q=class{constructor(e,t,n,s){this.x=e;this.y=t;this.z=n;this.t=s}static fromAffine(e){if(!(e instanceof V))throw new TypeError("ExtendedPoint#fromAffine: expected Point");return e.equals(V.ZERO)?Q.ZERO:new Q(e.x,e.y,I,y(e.x*e.y))}static toAffineBatch(e){let t=aa(e.map(n=>n.z));return e.map((n,s)=>n.toAffine(t[s]))}static normalizeZ(e){return this.toAffineBatch(e).map(this.fromAffine)}equals(e){cn(e);let{x:t,y:n,z:s}=this,{x:a,y:i,z:o}=e,c=y(t*o),l=y(a*s),h=y(n*o),d=y(i*s);return c===l&&h===d}negate(){return new Q(y(-this.x),this.y,this.z,y(-this.t))}double(){let{x:e,y:t,z:n}=this,{a:s}=P,a=y(e**X),i=y(t**X),o=y(X*y(n**X)),c=y(s*a),l=y(y((e+t)**X)-a-i),h=c+i,d=h-o,u=c-i,p=y(l*d),f=y(h*u),g=y(l*u),A=y(d*h);return new Q(p,f,A,g)}add(e){cn(e);let{x:t,y:n,z:s,t:a}=this,{x:i,y:o,z:c,t:l}=e,h=y((n-t)*(o+i)),d=y((n+t)*(o-i)),u=y(d-h);if(u===q)return this.double();let p=y(s*X*l),f=y(a*X*c),g=f+p,A=d+h,E=f-p,_=y(g*u),b=y(A*E),S=y(g*E),D=y(u*A);return new Q(_,b,D,S)}subtract(e){return this.add(e.negate())}precomputeWindow(e){let t=1+256/e,n=[],s=this,a=s;for(let i=0;i<t;i++){a=s,n.push(a);for(let o=1;o<2**(e-1);o++)a=a.add(s),n.push(a);s=a.double()}return n}wNAF(e,t){!t&&this.equals(Q.BASE)&&(t=V.BASE);let n=t&&t._WINDOW_SIZE||1;if(256%n)throw new Error("Point#wNAF: Invalid precomputation window, must be power of 2");let s=t&&gr.get(t);s||(s=this.precomputeWindow(n),t&&n!==1&&(s=Q.normalizeZ(s),gr.set(t,s)));let a=Q.ZERO,i=Q.ZERO,o=1+256/n,c=2**(n-1),l=BigInt(2**n-1),h=2**n,d=BigInt(n);for(let u=0;u<o;u++){let p=u*c,f=Number(e&l);if(e>>=d,f>c&&(f-=h,e+=I),f===0){let g=s[p];u%2&&(g=g.negate()),i=i.add(g)}else{let g=s[p+Math.abs(f)-1];f<0&&(g=g.negate()),a=a.add(g)}}return Q.normalizeZ([a,i])[0]}multiply(e,t){return this.wNAF(Ct(e,P.l),t)}multiplyUnsafe(e){let t=Ct(e,P.l,!1),n=Q.BASE,s=Q.ZERO;if(t===q)return s;if(this.equals(s)||t===I)return this;if(this.equals(n))return this.wNAF(t);let a=s,i=this;for(;t>q;)t&I&&(a=a.add(i)),i=i.double(),t>>=I;return a}isSmallOrder(){return this.multiplyUnsafe(P.h).equals(Q.ZERO)}isTorsionFree(){return this.multiplyUnsafe(P.l).equals(Q.ZERO)}toAffine(e=Ft(this.z)){let{x:t,y:n,z:s}=this,a=y(t*e),i=y(n*e);if(y(s*e)!==I)throw new Error("invZ was invalid");return new V(a,i)}fromRistrettoBytes(){fr()}toRistrettoBytes(){fr()}fromRistrettoHash(){fr()}},W=Q;W.BASE=new Q(P.Gx,P.Gy,I,y(P.Gx*P.Gy)),W.ZERO=new Q(q,I,I,q);function cn(r){if(!(r instanceof W))throw new TypeError("ExtendedPoint expected")}function pr(r){if(!(r instanceof Oe))throw new TypeError("RistrettoPoint expected")}function fr(){throw new Error("Legacy method: switch to RistrettoPoint")}var Te=class{constructor(e){this.ep=e}static calcElligatorRistrettoMap(e){let{d:t}=P,n=y(ct*e*e),s=y((n+I)*ta),a=BigInt(-1),i=y((a-t*n)*y(n+t)),{isValid:o,value:c}=wr(s,i),l=y(c*e);Ie(l)||(l=y(-l)),o||(c=l),o||(a=n);let h=y(a*(n-I)*ra-i),d=c*c,u=y((c+c)*i),p=y(h*Xs),f=y(I-d),g=y(I+d);return new W(y(u*g),y(f*p),y(p*g),y(u*f))}static hashToCurve(e){e=Ce(e,64);let t=mr(e.slice(0,32)),n=this.calcElligatorRistrettoMap(t),s=mr(e.slice(32,64)),a=this.calcElligatorRistrettoMap(s);return new Te(n.add(a))}static fromHex(e){e=Ce(e,32);let{a:t,d:n}=P,s="RistrettoPoint.fromHex: the hex is not valid encoding of RistrettoPoint",a=mr(e);if(!oa(lt(a),e)||Ie(a))throw new Error(s);let i=y(a*a),o=y(I+t*i),c=y(I-t*i),l=y(o*o),h=y(c*c),d=y(t*n*l-h),{isValid:u,value:p}=ln(y(d*h)),f=y(p*c),g=y(p*f*d),A=y((a+a)*f);Ie(A)&&(A=y(-A));let E=y(o*g),_=y(A*E);if(!u||Ie(_)||E===q)throw new Error(s);return new Te(new W(A,E,I,_))}toRawBytes(){let{x:e,y:t,z:n,t:s}=this.ep,a=y(y(n+t)*y(n-t)),i=y(e*t),{value:o}=ln(y(a*i**X)),c=y(o*a),l=y(o*i),h=y(c*l*s),d;if(Ie(s*h)){let p=y(t*ct),f=y(e*ct);e=p,t=f,d=y(c*ea)}else d=l;Ie(e*h)&&(t=y(-t));let u=y((n-t)*d);return Ie(u)&&(u=y(-u)),lt(u)}toHex(){return ut(this.toRawBytes())}toString(){return this.toHex()}equals(e){pr(e);let t=this.ep,n=e.ep,s=y(t.x*n.y)===y(t.y*n.x),a=y(t.y*n.y)===y(t.x*n.x);return s||a}add(e){return pr(e),new Te(this.ep.add(e.ep))}subtract(e){return pr(e),new Te(this.ep.subtract(e.ep))}multiply(e){return new Te(this.ep.multiply(e))}multiplyUnsafe(e){return new Te(this.ep.multiplyUnsafe(e))}},Oe=Te;Oe.BASE=new Te(W.BASE),Oe.ZERO=new Te(W.ZERO);var gr=new WeakMap,He=class{constructor(e,t){this.x=e;this.y=t}_setWindowSize(e){this._WINDOW_SIZE=e,gr.delete(this)}static fromHex(e,t=!0){let{d:n,P:s}=P;e=Ce(e,32);let a=e.slice();a[31]=e[31]&-129;let i=ze(a);if(t&&i>=s)throw new Error("Expected 0 < hex < P");if(!t&&i>=dn)throw new Error("Expected 0 < hex < 2**256");let o=y(i*i),c=y(o-I),l=y(n*o+I),{isValid:h,value:d}=wr(c,l);if(!h)throw new Error("Point.fromHex: invalid y coordinate");let u=(d&I)===I;return(e[31]&128)!==0!==u&&(d=y(-d)),new He(d,i)}static async fromPrivateKey(e){return(await Rt(e)).point}toRawBytes(){let e=lt(this.y);return e[31]|=this.x&I?128:0,e}toHex(){return ut(this.toRawBytes())}toX25519(){let{y:e}=this,t=y((I+e)*Ft(I-e));return lt(t)}isTorsionFree(){return W.fromAffine(this).isTorsionFree()}equals(e){return this.x===e.x&&this.y===e.y}negate(){return new He(y(-this.x),this.y)}add(e){return W.fromAffine(this).add(W.fromAffine(e)).toAffine()}subtract(e){return this.add(e.negate())}multiply(e){return W.fromAffine(this).multiply(e,this).toAffine()}},V=He;V.BASE=new He(P.Gx,P.Gy),V.ZERO=new He(q,I);var Ue=class{constructor(e,t){this.r=e;this.s=t;this.assertValidity()}static fromHex(e){let t=Ce(e,64),n=V.fromHex(t.slice(0,32),!1),s=ze(t.slice(32,64));return new Ue(n,s)}assertValidity(){let{r:e,s:t}=this;if(!(e instanceof V))throw new Error("Expected Point instance");return Ct(t,P.l,!1),this}toRawBytes(){let e=new Uint8Array(64);return e.set(this.r.toRawBytes()),e.set(lt(this.s),32),e}toHex(){return ut(this.toRawBytes())}};function na(...r){if(!r.every(n=>n instanceof Uint8Array))throw new Error("Expected Uint8Array list");if(r.length===1)return r[0];let e=r.reduce((n,s)=>n+s.length,0),t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){let a=r[n];t.set(a,s),s+=a.length}return t}var sa=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function ut(r){if(!(r instanceof Uint8Array))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=sa[r[t]];return e}function hn(r){if(typeof r!="string")throw new TypeError("hexToBytes: expected string, got "+typeof r);if(r.length%2)throw new Error("hexToBytes: received invalid unpadded hex");let e=new Uint8Array(r.length/2);for(let t=0;t<e.length;t++){let n=t*2,s=r.slice(n,n+2),a=Number.parseInt(s,16);if(Number.isNaN(a)||a<0)throw new Error("Invalid byte sequence");e[t]=a}return e}function pn(r){let t=r.toString(16).padStart(64,"0");return hn(t)}function lt(r){return pn(r).reverse()}function Ie(r){return(y(r)&I)===I}function ze(r){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");return BigInt("0x"+ut(Uint8Array.from(r).reverse()))}function mr(r){return y(ze(r)&X**un-I)}function y(r,e=P.P){let t=r%e;return t>=q?t:e+t}function Ft(r,e=P.P){if(r===q||e<=q)throw new Error(`invert: expected positive integers, got n=${r} mod=${e}`);let t=y(r,e),n=e,s=q,a=I,i=I,o=q;for(;t!==q;){let l=n/t,h=n%t,d=s-i*l,u=a-o*l;n=t,t=h,s=i,a=o,i=d,o=u}if(n!==I)throw new Error("invert: does not exist");return y(s,e)}function aa(r,e=P.P){let t=new Array(r.length),n=r.reduce((a,i,o)=>i===q?a:(t[o]=a,y(a*i,e)),I),s=Ft(n,e);return r.reduceRight((a,i,o)=>i===q?a:(t[o]=y(a*t[o],e),y(a*i,e)),s),t}function be(r,e){let{P:t}=P,n=r;for(;e-- >q;)n*=n,n%=t;return n}function ia(r){let{P:e}=P,t=BigInt(5),n=BigInt(10),s=BigInt(20),a=BigInt(40),i=BigInt(80),c=r*r%e*r%e,l=be(c,X)*c%e,h=be(l,I)*r%e,d=be(h,t)*h%e,u=be(d,n)*d%e,p=be(u,s)*u%e,f=be(p,a)*p%e,g=be(f,i)*f%e,A=be(g,i)*f%e,E=be(A,n)*d%e;return{pow_p_5_8:be(E,X)*r%e,b2:c}}function wr(r,e){let t=y(e*e*e),n=y(t*t*e),s=ia(r*n).pow_p_5_8,a=y(r*t*s),i=y(e*a*a),o=a,c=y(a*ct),l=i===r,h=i===y(-r),d=i===y(-r*ct);return l&&(a=o),(h||d)&&(a=c),Ie(a)&&(a=y(-a)),{isValid:l||h,value:a}}function ln(r){return wr(I,r)}async function yr(...r){let e=await dt.sha512(na(...r)),t=ze(e);return y(t,P.l)}function oa(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function Ce(r,e){let t=r instanceof Uint8Array?Uint8Array.from(r):hn(r);if(typeof e=="number"&&t.length!==e)throw new Error(`Expected ${e} bytes`);return t}function Ct(r,e,t=!0){if(!e)throw new TypeError("Specify max value");if(typeof r=="number"&&Number.isSafeInteger(r)&&(r=BigInt(r)),typeof r=="bigint"&&r<e){if(t){if(q<r)return r}else if(q<=r)return r}throw new TypeError("Expected valid scalar: 0 < scalar < max")}function ca(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}async function Rt(r){if(r=typeof r=="bigint"||typeof r=="number"?pn(Ct(r,dn)):Ce(r),r.length!==32)throw new Error("Expected 32 bytes");let e=await dt.sha512(r),t=ca(e.slice(0,32)),n=e.slice(32,64),s=y(ze(t),P.l),a=V.BASE.multiply(s),i=a.toRawBytes();return{head:t,prefix:n,scalar:s,point:a,pointBytes:i}}async function fn(r){return(await Rt(r)).pointBytes}async function mn(r,e){r=Ce(r);let{prefix:t,scalar:n,pointBytes:s}=await Rt(e),a=await yr(t,r),i=V.BASE.multiply(a),o=await yr(i.toRawBytes(),s,r),c=y(a+o*n,P.l);return new Ue(i,c).toRawBytes()}async function gn(r,e,t){e=Ce(e),t instanceof V||(t=V.fromHex(t,!1));let{r:n,s}=r instanceof Ue?r.assertValidity():Ue.fromHex(r),a=W.BASE.multiplyUnsafe(s),i=await yr(n.toRawBytes(),t.toRawBytes(),e),o=W.fromAffine(t).multiplyUnsafe(i);return W.fromAffine(n).add(o).subtract(a).multiplyUnsafe(P.h).equals(W.ZERO)}V.BASE._setWindowSize(8);var dt={TORSION_SUBGROUP:["0100000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac037a","0000000000000000000000000000000000000000000000000000000000000080","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc05","ecffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7f","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc85","0000000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac03fa"],bytesToHex:ut,getExtendedPublicKey:Rt,mod:y,invert:Ft,hashToPrivateScalar:r=>{if(r=Ce(r),r.length<40||r.length>1024)throw new Error("Expected 40-1024 bytes of private key as per FIPS 186");let e=y(ze(r),P.l);if(e===q||e===I)throw new Error("Invalid private key");return e},randomBytes:(r=32)=>crypto.getRandomValues(new Uint8Array(r)),randomPrivateKey:()=>dt.randomBytes(32),sha512:async r=>{let e=await crypto.subtle.digest("SHA-512",r.buffer);return new Uint8Array(e)},precompute(r=8,e=V.BASE){let t=e.equals(V.BASE)?e:new V(e.x,e.y);return t._setWindowSize(r),t.multiply(X),t}};var U=11400714785074694791n,H=14029467366897019727n,yn=1609587929392839161n,ht=9650029242287828579n,wn=2870177450012600261n,Tn=64n,la=2n**Tn-1n,ua=new TextEncoder;function bn(r,e,t,n){return BigInt(r)|BigInt(e)<<16n|BigInt(t)<<32n|BigInt(n)<<48n}function Se(r,e){return BigInt(r[e])|BigInt(r[e+1])<<8n|BigInt(r[e+2])<<16n|BigInt(r[e+3])<<24n|BigInt(r[e+4])<<32n|BigInt(r[e+5])<<40n|BigInt(r[e+6])<<48n|BigInt(r[e+7])<<56n}function K(r,e){return r<<e&la|r>>Tn-e}function x(r){return BigInt.asUintN(64,r)}var Fe=class{#t;#n;#e;#a;#s;#i;#o;#r;constructor(e=0){this.reset(e)}reset(e=this.#t){return this.#t=BigInt.asUintN(32,BigInt(e)),this.#n=x(this.#t+U+H),this.#e=x(this.#t+H),this.#a=this.#t,this.#s=x(this.#t-U),this.#i=null,this.#o=0,this.#r=0,this}update(e){typeof e=="string"&&(e=ua.encode(e));let t=0,n=e.length,s=t+n;if(n===0)return this;if(this.#o+=n,this.#r===0&&(this.#i=new Uint8Array(32)),this.#r+n<32)return this.#i.set(e.subarray(0,n),this.#r),this.#r+=n,this;if(this.#r>0){this.#i.set(e.subarray(0,32-this.#r),this.#r);let a=0,i;i=Se(this.#i,a),this.#n=x(K(x(this.#n+i*H),31n)*U),a+=8,i=Se(this.memory,a),this.#e=x(K(x(this.#e+i*H),31n)*U),a+=8,i=Se(this.memory,a),this.#a=x(K(x(this.#a+i*H),31n)*U),a+=8,i=Se(this.memory,a),this.#s=x(K(x(this.#s+i*H),31n)*U),t+=32-this.#r,this.#r=0}if(t<=s-32){let a=s-32;do{let i;i=Se(e,t),this.#n=x(K(x(this.#n+i*H),31n)*U),t+=8,i=Se(e,t),this.#e=x(K(x(this.#e+i*H),31n)*U),t+=8,i=Se(e,t),this.#a=x(K(x(this.#a+i*H),31n)*U),t+=8,i=Se(e,t),this.#s=x(K(x(this.#s+i*H),31n)*U),t+=8}while(t<=a)}return t<s&&(this.#i.set(e.subarray(t,s),this.#r),this.#r=s-t),this}digest(){let e=this.#i,t=this.#r,n=0,s=0n,a=0n,i=0n;for(this.#o>=32?(s=K(this.#n,1n)+K(this.#e,7n)+K(this.#a,12n)+K(this.#s,18n),s=x(s^K(x(this.#n*H),31n)*U),s=x(s*U+ht),s=x(s^K(x(this.#e*H),31n)*U),s=x(s*U+ht),s=x(s^K(x(this.#a*H),31n)*U),s=x(s*U+ht),s=x(s^K(x(this.#s*H),31n)*U),s=x(s*U+ht)):s=x(this.#t+wn),s+=BigInt(this.#o);n<=t-8;)i=Se(e,n),i=x(K(x(i*H),31n)*U),s=x(K(s^i,27n)*U+ht),n+=8;for(n+4<=t&&(i=bn(e[n+1]<<8|e[n],e[n+3]<<8|e[n+2],0,0),s=x(K(s^x(i*U),23n)*H+yn),n+=4);n<t;)i=bn(e[n++],0,0,0),s=x(K(s^x(i*wn),11n)*U);return a=x(s>>33n),s=x((s^a)*H),a=x(s>>29n),s=x((s^a)*yn),a=x(s>>32n),s=x(s^a),s}};function br(r,e=0){return new Fe(e).update(r).digest()}function Pt(r,e){return r<e?-1:r>e?1:0}var de=class{constructor(e,t){this.parent=e;this.value=t;this.left=null,this.right=null}static from(e){let t=new de(e.parent,e.value);return t.left=e.left,t.right=e.right,t}directionFromParent(){return this.parent===null?null:this===this.parent.left?"left":this===this.parent.right?"right":null}findMinNode(){let e=this.left;for(;e?.left;)e=e.left;return e??this}findMaxNode(){let e=this.right;for(;e?.right;)e=e.right;return e??this}findSuccessorNode(){if(this.right!==null)return this.right.findMinNode();let e=this.parent,t=this.directionFromParent();for(;e&&t==="right";)t=e.directionFromParent(),e=e.parent;return e}};var De=class{constructor(e=Pt){this.compare=e;this.root=null;this._size=0}static from(e,t){let n,s=[];if(e instanceof De)if(n=new De(t?.compare??e.compare),t?.compare||t?.map)s=e;else{let i=[];for(e.root&&(n.root=de.from(e.root),i.push(n.root));i.length;){let o=i.pop(),c=o.left?de.from(o.left):null,l=o.right?de.from(o.right):null;c&&(c.parent=o,i.push(c)),l&&(l.parent=o,i.push(l))}}else n=t?.compare?new De(t.compare):new De,s=e;let a=t?.map?Array.from(s,t.map,t.thisArg):s;for(let i of a)n.insert(i);return n}get size(){return this._size}findNode(e){let t=this.root;for(;t;){let n=this.compare(e,t.value);if(n===0)break;let s=n<0?"left":"right";t=t[s]}return t}rotateNode(e,t){let n=t==="left"?"right":"left";if(!e[n])throw new TypeError(`cannot rotate ${t} without ${n} child`);let s=e[n];if(e[n]=s[t]??null,s[t]&&(s[t].parent=e),s.parent=e.parent,e.parent){let a=e===e.parent[t]?t:n;e.parent[a]=s}else this.root=s;s[t]=e,e.parent=s}insertNode(e,t){if(this.root){let n=this.root;for(;;){let s=this.compare(t,n.value);if(s===0)break;let a=s<0?"left":"right";if(n[a])n=n[a];else return n[a]=new e(n,t),this._size++,n[a]}}else return this.root=new e(null,t),this._size++,this.root;return null}removeNode(e){let t=this.findNode(e);if(t){let n=!t.left||!t.right?t:t.findSuccessorNode(),s=n.left??n.right;s&&(s.parent=n.parent),n.parent?n.parent[n.directionFromParent()]=s:this.root=s,n!==t&&(t.value=n.value,t=n),this._size--}return t}insert(e){return!!this.insertNode(de,e)}remove(e){return!!this.removeNode(e)}find(e){return this.findNode(e)?.value??null}min(){return this.root?this.root.findMinNode().value:null}max(){return this.root?this.root.findMaxNode().value:null}clear(){this.root=null,this._size=0}isEmpty(){return this.size===0}*lnrValues(){let e=[],t=this.root;for(;e.length||t;)t?(e.push(t),t=t.left):(t=e.pop(),yield t.value,t=t.right)}*rnlValues(){let e=[],t=this.root;for(;e.length||t;)t?(e.push(t),t=t.right):(t=e.pop(),yield t.value,t=t.left)}*nlrValues(){let e=[];for(this.root&&e.push(this.root);e.length;){let t=e.pop();yield t.value,t.right&&e.push(t.right),t.left&&e.push(t.left)}}*lrnValues(){let e=[],t=this.root,n=null;for(;e.length||t;)if(t)e.push(t),t=t.left;else{let s=e[e.length-1];s.right&&s.right!==n?t=s.right:(yield s.value,n=e.pop())}}*lvlValues(){let e=[],t=this.root;for(;t;)yield t.value,t.left&&e.push(t.left),t.right&&e.push(t.right),t=e.shift()??null}*[Symbol.iterator](){yield*this.lnrValues()}};var he=class extends de{constructor(t,n){super(t,n);this.red=!0}static from(t){let n=new he(t.parent,t.value);return n.left=t.left,n.right=t.right,n.red=t.red,n}};var xe=class extends De{constructor(t=Pt){super(t)}static from(t,n){let s,a=[];if(t instanceof xe)if(s=new xe(n?.compare??t.compare),n?.compare||n?.map)a=t;else{let o=[];for(t.root&&(s.root=he.from(t.root),o.push(s.root));o.length;){let c=o.pop(),l=c.left?he.from(c.left):null,h=c.right?he.from(c.right):null;l&&(l.parent=c,o.push(l)),h&&(h.parent=c,o.push(h))}}else s=n?.compare?new xe(n.compare):new xe,a=t;let i=n?.map?Array.from(a,n.map,n.thisArg):a;for(let o of i)s.insert(o);return s}removeFixup(t,n){for(;t&&!n?.red;){let s=t.left===n?"left":"right",a=s==="right"?"left":"right",i=t[a];i?.red&&(i.red=!1,t.red=!0,this.rotateNode(t,s),i=t[a]),i&&(!i.left?.red&&!i.right?.red?(i.red=!0,n=t,t=n.parent):(i[a]?.red||(i[s].red=!1,i.red=!0,this.rotateNode(i,a),i=t[a]),i.red=t.red,t.red=!1,i[a].red=!1,this.rotateNode(t,s),n=this.root,t=null))}n&&(n.red=!1)}insert(t){let n=this.insertNode(he,t);if(n){for(;n.parent?.red;){let s=n.parent,a=s.directionFromParent(),i=a==="right"?"left":"right",o=s.parent[i]??null;o?.red?(s.red=!1,o.red=!1,s.parent.red=!0,n=s.parent):(n===s[i]&&(n=s,this.rotateNode(n,a),s=n.parent),s.red=!1,s.parent.red=!0,this.rotateNode(s.parent,i))}this.root.red=!1}return!!n}remove(t){let n=this.removeNode(t);return n&&!n.red&&this.removeFixup(n.parent,n.left??n.right),!!n}};function Tr(r,e){return{lift:t=>[r.lift(t),e.lift(t)],combine:(t,n)=>{let s=r.combine(t[0],n[0]),a=e.combine(t[1],n[1]);return[s,a]},neutral:[r.neutral,e.neutral]}}var vn={lift:r=>1,combine:(r,e)=>r+e,neutral:0};var An=!1,Lt=class extends he{constructor(t,n,s){super(t,n);this.label=s.neutral,this.liftedValue=s.lift(n),this.monoid=s}updateLabel(t=!0,n){this.left!==null&&this.right===null?this.label=this.monoid.combine(this.left.label,this.liftedValue):this.left===null&&this.right!==null?this.label=this.monoid.combine(this.liftedValue,this.right.label):this.left&&this.right?this.label=this.monoid.combine(this.left?.label||this.monoid.neutral,this.monoid.combine(this.liftedValue,this.right?.label||this.monoid.neutral)):this.label=this.liftedValue,An&&(n&&console.log(n),console.group("Updating...",this.value),console.log("Lifted value",this.liftedValue),console.log("Label L",this.left?.label||this.monoid.neutral),console.log("Label R",this.right?.label||this.monoid.neutral),console.log("Label",this.label),console.groupEnd()),t&&this.parent?.updateLabel(!0,"Updated by child")}},pt=class extends xe{constructor(t,n){super(n);this.monoid=Tr(t,Tr(vn,{lift:s=>[s],combine:(s,a)=>s.concat(a),neutral:[]}))}getLowestValue(){if(!this.root)throw new Error("Can't get a range from a tree with no items");return this.root.findMinNode().value}rotateNode(t,n){let s=n==="left"?"right":"left";if(!t[s])throw new TypeError(`cannot rotate ${n} without ${s} child`);An&&console.group("Rotating",n);let a=t[s];if(t[s]=a[n]??null,a[n]&&(a[n].parent=t),a.parent=t.parent,t.parent){let i=t===t.parent[n]?n:s;t.parent[i]=a}else this.root=a;a[n]=t,t.parent=a,a[n]?.updateLabel(!1,"Node rotated"),console.groupEnd()}removeFixup(t,n){for(;t&&!n?.red;){let s=t.left===n?"left":"right",a=s==="right"?"left":"right",i=t[a];i?.red&&(i.red=!1,t.red=!0,this.rotateNode(t,s),i=t[a]),i&&(!i.left?.red&&!i.right?.red?(i.red=!0,n=t,t=n.parent):(i[a]?.red||(i[s].red=!1,i.red=!0,this.rotateNode(i,a),i=t[a]),i.red=t.red,t.red=!1,i[a].red=!1,this.rotateNode(t,s),n=this.root,t=null))}n&&(n.red=!1)}insertFingerprintNode(t){if(this.root){let n=this.root;for(;;){let s=this.compare(t,n.value);if(s===0)break;let a=s<0?"left":"right";if(n[a])n=n[a];else return n[a]=new Lt(n,t,this.monoid),this._size++,n[a]}}else return this.root=new Lt(null,t,this.monoid),this._size++,this.root;return null}insert(t){let n=this.insertFingerprintNode(t),s=n;if(s){for(;s.parent?.red;){let a=s.parent,i=a.directionFromParent(),o=i==="right"?"left":"right",c=a.parent[o]??null;c?.red?(a.red=!1,c.red=!1,a.parent.red=!0,s=a.parent):(s===a[o]&&(s=a,this.rotateNode(s,i),a=s.parent),a.red=!1,a.parent.red=!0,this.rotateNode(a.parent,o))}this.root.red=!1}return n?.updateLabel(!0,"Node inserted"),!!s}remove(t){let n=this.removeNode(t);return n&&!n.red&&this.removeFixup(n.parent,n.left??n.right),n&&n.parent?.updateLabel(!0,"Child node removed"),!!n}getFingerprint(t,n,s){if(this.root===null)return{fingerprint:this.monoid.neutral[0],size:0,items:[],nextTree:null};let a=s||this.findGteNode(t),i=this.compare(t,n);if(i===0)return{fingerprint:this.root.label[0],size:this.root.label[1][0],items:this.root.label[1][1],nextTree:null};if(i<0){let{label:o,nextTree:c}=this.aggregateUntil(a,t,n);return{fingerprint:o[0],size:o[1][0],items:o[1][1],nextTree:c}}else{let o=this.root.findMinNode(),c=this.root.findMaxNode(),{label:l,nextTree:h}=this.aggregateUntil(a,t,c.value),d=this.monoid.combine(l,this.compare(c.value,t)>=0?this.monoid.lift(c.value):this.monoid.neutral);if(o.value===n)return{fingerprint:d[0],size:d[1][0],items:d[1][1],nextTree:h};let{label:u,nextTree:p}=this.aggregateUntil(o,o.value,n),f=this.monoid.combine(u,d);return{fingerprint:f[0],size:f[1][0],items:f[1][1],nextTree:p}}}findGteNode(t){let n=this.root;for(;n;){let s=this.compare(t,n.value);if(s===0)break;let a=s<0?"left":"right";if(n[a])n=n[a];else break}return n}aggregateUntil(t,n,s){let{label:a,nextTree:i}=this.aggregateUp(t,n,s);return i===null||this.compare(i.value,s)>=0?{label:a,nextTree:i}:this.aggregateDown(i.right,s,this.monoid.combine(a,i.liftedValue))}aggregateUp(t,n,s){let a=this.monoid.neutral,i=t;for(;this.compare(i.findMaxNode().value,s)<0;){if(this.compare(i.value,n)>=0&&(a=this.monoid.combine(a,this.monoid.combine(i.liftedValue,i.right?.label||this.monoid.neutral))),i.parent===null)return{label:a,nextTree:null};i=i.parent}return{label:a,nextTree:i}}aggregateDown(t,n,s){let a=t,i=s;for(;a!==null;)if(this.compare(a.value,n)<0)i=this.monoid.combine(i,this.monoid.combine(a.left?.label||this.monoid.neutral,a.liftedValue)),a=a.right;else{if(a.left===null||this.compare(a.left.findMaxNode().value,n)<0)return{label:this.monoid.combine(i,a.left?.label||this.monoid.neutral),nextTree:a};a=a.left}return{label:i,nextTree:null}}};function Sn(){let r,e="pending",t=new Promise((n,s)=>{r={async resolve(a){await a,e="fulfilled",n(a)},reject(a){e="rejected",s(a)}}});return Object.defineProperty(t,"state",{get:()=>e}),Object.assign(t,r)}var Mt=class{constructor(){this.deferreds=new Set;this.state="pending"}resolve(e){if(this.state==="pending"){this.state="fulfilled";for(let t of this.deferreds)t.resolve(e)}}reject(e){if(this.state==="pending"){this.state="rejected";for(let t of this.deferreds)t.reject(e)}}tee(){let e=Sn();return this.state==="fulfilled"?e.resolve():this.state==="rejected"?e.reject():this.deferreds.add(e),e}};var ft=class{constructor(e){this.isDoneTee=new Mt;this.insertionCallbacks=new Set;this.lowerBoundFromPrev=null;this.collatedPayload=null;this.collatePayloads=e=>{switch(e.type){case"payload":{let t=this.collatedPayload;if(t===null&&(t={type:"payload",lowerBound:e.lowerBound,payload:[],end:{canRespond:!1,upperBound:e.payload}}),t.payload.push(e.payload),this.collatedPayload=t,e.end)return e.end.upperBound?t.end=e.end:t.end={...e.end,upperBound:e.payload},this.collatedPayload=null,t;break}default:return this.collatedPayload&&(this.collatedPayload=null),e}};this.reusableTree=void 0;this.lastAdjacentDoneUpperBound=null;this.isDoneSoFar=!0;this.tree=e.tree,this.fingerprintEquals=e.fingerprintEquals,this.encoding=e.encoding,this.payloadThreshold=e.payloadThreshold,this.rangeDivision=e.rangeDivision}decode(e){let t=this.lowerBoundFromPrev;try{return{type:"emptySet",canRespond:this.encoding.decode.emptySet(e)}}catch{}try{let n=this.encoding.decode.lowerBound(e);return this.lowerBoundFromPrev=n,{type:"lowerBound",value:n}}catch{}try{return this.encoding.decode.terminal(e),{type:"terminal"}}catch{}try{let n=this.encoding.decode.done(e);return this.lowerBoundFromPrev=n,{lowerBound:t,type:"done",upperBound:n}}catch{}try{let n=this.encoding.decode.fingerprint(e);return this.lowerBoundFromPrev=n.upperBound,{type:"fingerprint",lowerBound:t,fingerprint:n.fingerprint,upperBound:n.upperBound}}catch{}try{let n=this.encoding.decode.payload(e);return n.end&&(this.lowerBoundFromPrev=n.end.upperBound),{type:"payload",lowerBound:t,payload:n.value,...n.end?{end:n.end}:{}}}catch{}try{let n=this.encoding.decode.emptyPayload(e);return this.lowerBoundFromPrev=n,{lowerBound:t,type:"emptyPayload",upperBound:n}}catch{}return null}setReusableTree(e){this.reusableTree=e||void 0}process(e){let t=this.reusableTree;switch(e.type){case"lowerBound":case"terminal":case"done":return this.setReusableTree(null),[e];case"emptySet":{if(e.canRespond===!1&&this.isDoneTee.resolve(),this.tree.size===0)return[{type:"emptySet",canRespond:!1}];let n=this.tree.getLowestValue(),s=[{type:"lowerBound",value:n}],a=Array.from(this.tree.lnrValues());for(let i=0;i<a.length;i++){let o=a[i];i===a.length-1?s.push({type:"payload",payload:o,end:{upperBound:n,canRespond:!1}}):s.push({type:"payload",payload:o})}return s.push({type:"terminal"}),s}case"fingerprint":{let{fingerprint:n,size:s,items:a,nextTree:i}=this.tree.getFingerprint(e.lowerBound,e.upperBound,t);if(this.setReusableTree(i),this.fingerprintEquals(n,e.fingerprint))return[{type:"done",upperBound:e.upperBound}];if(s<=this.payloadThreshold){if(s===0)return[{type:"emptyPayload",upperBound:e.upperBound}];let o=[];for(let c=0;c<s;c++)o.push({type:"payload",payload:a[c],...c===a.length-1?{end:{upperBound:e.upperBound,canRespond:!0}}:{}});return o}else{let o=Math.ceil(s/this.rangeDivision),c=[];if(o<=this.payloadThreshold){for(let u=0;u<a.length;u++)c.push({type:"payload",payload:a[u],...u===a.length-1?{end:{upperBound:e.upperBound,canRespond:!0}}:{}});return c}let l,h=a,d=!1;if(e.lowerBound>=e.upperBound){let u=a.findIndex(p=>p>=e.lowerBound);if(u>0){let p=h.splice(0,u);h.push(...p),d=!0}}for(let u=0;u<s;u+=o){let p=h[u],f=h[u+o]||e.upperBound,{fingerprint:g,nextTree:A}=this.tree.getFingerprint(p,f,l);l=d?void 0:A||void 0,c.push({type:"fingerprint",fingerprint:g,upperBound:f})}return c}}case"payload":{for(let n of e.payload){this.tree.insert(n);for(let s of this.insertionCallbacks)s(n)}if(e.end.canRespond){let{items:n,size:s,nextTree:a}=this.tree.getFingerprint(e.lowerBound,e.end.upperBound,t);if(this.setReusableTree(a),s===0)return[{type:"emptyPayload",upperBound:e.end.upperBound}];let i=[];for(let o=0;o<s;o++)i.push({type:"payload",payload:n[o],...o===n.length-1?{end:{upperBound:e.end.upperBound,canRespond:!1}}:{}});return i}else return this.setReusableTree(null),[{type:"done",upperBound:e.end.upperBound}]}case"emptyPayload":{this.setReusableTree(null);let{items:n,size:s,nextTree:a}=this.tree.getFingerprint(e.lowerBound,e.upperBound);if(this.setReusableTree(a),s===0)return this.setReusableTree(null),[];let i=[];for(let o=0;o<s;o++)i.push({type:"payload",payload:n[o],...o===n.length-1?{end:{upperBound:e.upperBound,canRespond:!1}}:{}});return i}}}consolidateAdjacentDones(e){switch(e.type){case"done":{this.lastAdjacentDoneUpperBound=e.upperBound;break}default:{let t=this.lastAdjacentDoneUpperBound;return t?(this.lastAdjacentDoneUpperBound=null,[{type:"done",upperBound:t},e]):[e]}}}checkIsDone(e){switch(e.type){case"emptySet":{e.canRespond&&(this.isDoneSoFar=!1);break}case"lowerBound":break;case"fingerprint":this.isDoneSoFar=!1;break;case"emptyPayload":this.isDoneSoFar=!1;break;case"payload":e.end?.canRespond===!0&&(this.isDoneSoFar=!1);break;case"terminal":this.isDoneSoFar?this.isDoneTee.resolve():this.isDoneSoFar=!0}}encode(e){let t;switch(e.type){case"emptySet":{t=this.encoding.encode.emptySet(e.canRespond);break}case"lowerBound":{t=this.encoding.encode.lowerBound(e.value);break}case"done":{t=this.encoding.encode.done(e.upperBound);break}case"fingerprint":{t=this.encoding.encode.fingerprint(e.fingerprint,e.upperBound);break}case"payload":{t=this.encoding.encode.payload(e.payload,e.end);break}case"emptyPayload":{t=this.encoding.encode.emptyPayload(e.upperBound);break}case"terminal":{t=this.encoding.encode.terminal();break}}return t}respond(e){if(this.isDone().state==="fulfilled")return[];let t=this.decode(e),n=this.collatePayloads(t);if(n===void 0)return[];let s=this.process(n||[]),a=[];for(let o of s){let c=this.consolidateAdjacentDones(o);c&&a.push(...c)}for(let o of a)this.checkIsDone(o);let i=[];for(let o of a)i.push(this.encode(o));return i}isDone(){return this.isDoneTee.tee()}initialMessages(e){let{tree:t,encoding:n,payloadThreshold:s,rangeDivision:a}=this;function*i(){if(t.size===0){yield n.encode.emptySet(!0);return}let o=t.getLowestValue();yield n.encode.lowerBound(o);let{items:l}=t.getFingerprint(o,o),d=(e||(f=>{let g=Math.ceil(f.length/a),A=[];for(let E=0;E<f.length;E+=g){let _=f.slice(E,E+g);A.push(_)}return A}))(l),u;for(let f=0;f<d.length;f++){let g=d[f+1]?d[f+1][0]:o,A=d[f];if(A.length<=s)for(let E=0;E<A.length;E++)yield n.encode.payload(A[E],E===A.length-1?{upperBound:g,canRespond:!0}:void 0);else{let E=A[0],{fingerprint:_,nextTree:b}=t.getFingerprint(E,g,u);u=b||void 0,yield n.encode.fingerprint(_,g)}}yield n.encode.terminal()}return i()}onInsertion(e){return this.insertionCallbacks.add(e),()=>{this.insertionCallbacks.delete(e)}}};var Dn=Symbol("Stream ended."),vr=Symbol("Stream errored."),$=class{constructor(e){this.#t=[];this.#n=null;this.push=(...e)=>{e.length?this.#s(!1,e):(this.#s(!1,[vr]),this.#a(new Error("AsyncQueueError: queue.push was called with no arguments")))};this.close=({immediately:e=!1,withError:t}={})=>{t&&this.#a(t),this.#s(e,[t?vr:Dn]),this.push=this.close=()=>{}};e?.catch?.(t=>this.close({withError:t}))?.finally?.(()=>this.close())}#t;#n;#e;#a(e){this.#e instanceof AggregateError?this.#e.errors.push(e):this.#e?this.#e=new AggregateError([this.#e,e]):this.#e=e}#s(e,t){this.#t[e?"unshift":"push"](...t),this.#n?.(this.#t.shift()),this.#n=null}get length(){return this.#t.length}async*[Symbol.asyncIterator](){for(;;){let e=this.#t.length?this.#t.shift():await new Promise(t=>{this.#n=t});if(e===vr)throw this.#e;if(e===Dn)break;yield e}}};function T(){let r,e="pending",t=new Promise((n,s)=>{r={async resolve(a){await a,e="fulfilled",n(a)},reject(a){e="rejected",s(a)}}});return Object.defineProperty(t,"state",{get:()=>e}),Object.assign(t,r)}var da=new TextDecoder,ha=new TextEncoder;function fo(r){return da.decode(r)}function Ge(r){return ha.encode(r)}function xn(r){return Ge(r).length}function mo(r,e){if(!e||e.length===0)return r;if(!r||r.length===0)return e;var t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function go(r){return $e.base64.parse(r)}function pa(r){return r?.constructor?.name==="Uint8Array"}function fa(r){return r?.constructor?.name==="Buffer"}function yo(r){return pa(r)?"bytes":fa(r)?"buffer":"?"}function mt(r,e){for(let t of r)if(e.indexOf(t)===-1)return!1;return!0}function To(r){let e=Ge(r);for(let t of e)if(t<32||t>126)return!1;return!0}function Ar(r){return r===""?!1:gt.indexOf(r)!==-1}var Re="abcdefghijklmnopqrstuvwxyz",ma=Re.toUpperCase(),gt="0123456789",pe=Re+"234567",Sr=Re+gt,En=pe,_t=Sr+pe+"@.",Dr=Re+gt,Nt=Re+gt,Ot=Dr+pe+"+.",ga="/'()-._~!$&+,:=@%",Ut=Re+ma+gt+ga;function Vt(r,e){return`@${r}.${e}`}function Kt(r,e){return`+${r}.${e}`}function Je(r){let e=Bn(r);return hr(e)?!0:e}function z(r){let e=kn(r);return hr(e)?!0:e}function yt(r){return r.startsWith("@")?Bn(r):r.startsWith("+")?kn(r):new m("address must start with either @ or +")}function Bn(r){return In(r,{sigil:"@",separator:".",minNameLength:4,maxNameLength:4,minPubkeyLength:53,maxPubkeyLength:53,allowedNameCharacters:Sr,allowedPubkeyCharacters:En,pubkeyMustStartWithB:!0})}function kn(r){return In(r,{sigil:"+",separator:".",minNameLength:1,maxNameLength:15,minPubkeyLength:1,maxPubkeyLength:53,allowedNameCharacters:Dr,allowedPubkeyCharacters:Nt,pubkeyMustStartWithB:!1})}function In(r,e){let{sigil:t,separator:n,minNameLength:s,maxNameLength:a,minPubkeyLength:i,maxPubkeyLength:o,allowedNameCharacters:c,allowedPubkeyCharacters:l,pubkeyMustStartWithB:h}=e;if(typeof r!="string")return new m("address must be a string");if(r.length<4)return new m("address is too short");if(r[0]!==t)return new m(`address must start with a sigil: "${t}"`);if(r.indexOf(n)===-1)return new m(`address must contain a separator character: "${n}"`);let d=r.slice(1).split(n);if(d.length!==2)return new m(`address must have exactly 2 parts separated by a "${n}" separator`);let[u,p]=d;return u.length<s||u.length>a?new m(`name must be between ${s} and ${a} characters long, but is ${u.length}`):p.length<i||p.length>o?new m(`pubkey must be between ${i} and ${o} characters long, but is ${p.length}`):mt(u,c)?mt(p,l)?Ar(u[0])?new m(`name "${u}" must not start with a digit`):Ar(p[0])?new m(`pubkey "${p}" must not start with a digit`):h&&p[0]!=="b"?new m(`pubkey "${p}" must start with 'b'`):{address:r,name:u,pubkey:p}:new m(`pubkey "${p}" must only have allowed characters`):new m(`name "${u}" must only have allowed characters`)}function Ze(r){return!(Object.prototype.toString.call(r)!=="[object Object]"||(""+r.constructor).startsWith("class"))}function Bo(r){return Ze(r)?null:"expected plain object but got "+r}function qt(r){return e=>e!==r?`expected literal value ${JSON.stringify(r)}`:null}function G(r={}){return e=>{if(r.optional!==!0&&e===void 0)return"required";if(r.optional===!0&&e===void 0)return null;let t=xn(e);return typeof e!="string"?"expected a string but got "+JSON.stringify(e):r.minLen!==void 0&&t<r.minLen?`string shorter than min length of ${r.minLen} chars`:r.maxLen!==void 0&&t>r.maxLen?`string shorter than max length of ${r.maxLen} chars`:r.len!==void 0&&t!==r.len?`string does not have required length of ${r.len} chars: ${e}`:r.allowedChars!==void 0&&!mt(e,r.allowedChars)?"contains disallowed characters":null}}function Ke(r={}){return e=>r.optional!==!0&&e===void 0?"required":r.optional===!0&&e===void 0?null:r.nullable!==!0&&e===null?"not nullable":r.nullable===!0&&e===null?null:typeof e!="number"?"expected a number but got "+JSON.stringify(e):isNaN(e)?"is NaN":isFinite(e)?e!==Math.round(e)?"expected an integer":r.min!==void 0&&e<r.min?`integer too small (must be >= ${r.min})`:r.max!==void 0&&e>r.max?`integer too large (must be <= ${r.max})`:null:"is Infinity"}function Wt(r={}){return r.allowLiteralUndefined=r.allowLiteralUndefined??!1,r.allowExtraKeys=r.allowExtraKeys??!1,e=>{if(!Ze(e))return"expected an object";if(r.allowLiteralUndefined===!1){for(let[t,n]of Object.entries(e))if(n===void 0)return`${t} is explicitly set to undefined but should be missing instead`}if(r.objSchema!==void 0){if(r.allowExtraKeys===!1){let t=Object.keys(e),n=Object.keys(r.objSchema),s=t.filter(a=>n.indexOf(a)===-1);if(s.length>0)return`object has extra keys not in the schema: ${s.join(", ")}`}for(let[t,n]of Object.entries(r.objSchema)){let s=n(e[t]);if(s!==null)return`${t}: ${s}`}}return null}}var{codec:Cn}=$e,Fn={chars:"abcdefghijklmnopqrstuvwxyz234567",bits:5};function le(r){return"b"+Cn.stringify(r,Fn,{pad:!1})}function Ye(r){if(!r.startsWith("b"))throw new m("can't decode base32 string - it should start with a 'b'. "+r);if(r[r.length-1]==="=")throw new m("can't decode base32 string - it contains padding characters ('=')");return Cn.parse(r.slice(1),Fn,{loose:!0})}var ya=(i=>(i[i.None=-1]="None",i[i.Error=0]="Error",i[i.Warn=1]="Warn",i[i.Log=2]="Log",i[i.Info=3]="Info",i[i.Debug=4]="Debug",i))(ya||{}),wa=0,Pe={_default:wa};function Ro(r){Pe={...Pe,...r}}function Po(r,e){Pe[r]=e}function Lo(r){Pe._default=r}function ba(r){return r in Pe?Pe[r]:Pe._default}function Mo(){return Pe}var C=class{constructor(e,t){this.color=void 0;this.source=e,this.color=t||"aqua"}_print(e,t,n,...s){if(e<=ba(this.source))if(t){let a=`[${this.source}]`;if(this.color!==void 0){let i=[`%c ${a}`,`color: ${this.color}`];console.log(n,...i,...s)}else console.log(n,a,...s)}else console.log(n,...s)}error(...e){this._print(0,!0,"!!",...e)}warn(...e){this._print(1,!0,"! ",...e)}log(...e){this._print(2,!0,"  ",...e)}info(...e){this._print(3,!0,"    ",...e)}debug(...e){this._print(4,!0,"      ",...e)}blank(){this._print(3,!1,"")}};var jt=class{constructor(e){this.hash=e.hash,this.internalUpdate=e.update,this.internalDigest=e.digest}update(e){return this.hash=this.internalUpdate(this.hash,e),this.hash}digest(){return this.internalDigest(this.hash)}};var{createHash:xr}=It,Er=new C("crypto-driver-noble","cyan"),Rn=class{static sha256(r){return typeof r=="string"?Promise.resolve(xr("sha256").update(r,"utf-8").digest()):Promise.resolve(xr("sha256").update(r).digest())}static updatableSha256(){return new jt({hash:xr("sha256"),update:(r,e)=>r.update(e),digest:r=>r.digest()})}static async generateKeypairBytes(){Er.debug("generateKeypairBytes");let r=Ve.utils.randomPrivateKey();return{pubkey:await Ve.getPublicKey(r),secret:r}}static sign(r,e){return Er.debug("sign"),typeof e=="string"&&(e=Ge(e)),Ve.sign(e,r.secret)}static async verify(r,e,t){Er.debug("verify");try{return typeof t=="string"&&(t=Ge(t)),await Ve.verify(e,t,r)}catch{return!1}}};function Br(){return Date.now()*1e3}function Qt(r){return new Promise(e=>{setTimeout(e,r)})}function re(){return""+Math.floor(Math.random()*1e3)+Math.floor(Math.random()*1e3)}function wt(r,e,t){return r.split(e).join(t)}function kr(r,e){if(e.length!=1)throw new Error("char must have length 1 but is "+JSON.stringify(e));return r.split(e).length-1}function Pn(r){return Object.keys(r).length===0}function zo(r){let e=o=>o[Math.floor(Math.random()*o.length)],t=e(Re),n=Array.from(Array(11),()=>e(Nt)).join(""),s=`${t}${n}`,a=`+${r}.${s}`,i=z(a);return w(i)?i:a}function Xo(r,e){return{address:Vt(r,le(e.pubkey)),secret:le(e.secret)}}function ec(r,e){return{address:Kt(r,le(e.pubkey)),secret:le(e.secret)}}function Ln(r){try{let e=Ir(r)?r.address:r.shareAddress,t=yt(e);if(w(t))return t;let n={pubkey:Ye(t.pubkey),secret:Ye(r.secret)};return n.pubkey.length!==32?new m(`pubkey bytes should be 32 bytes long, not ${n.pubkey.length} after base32 decoding.  ${e}`):n.secret.length!==32?new m(`secret bytes should be 32 bytes long, not ${n.secret.length} after base32 decoding.  ${r.secret}`):n}catch(e){return new m("crash while decoding author keypair: "+e.message)}}function Ir(r){return"address"in r}var Mn=Rn;var Ta=new C("crypto","cyan"),Le=Mn;function ic(r){Ta.debug(`set global crypto driver: ${r.name}`),Le=r}var bt=new C("crypto","cyan"),L=class{static async sha256base32(r){let e=await Le.sha256(r);return le(e)}static updatableSha256(){return Le.updatableSha256()}static async generateAuthorKeypair(r){bt.debug(`generateAuthorKeypair("${r}")`);let e=await Le.generateKeypairBytes(),t={address:Vt(r,le(e.pubkey)),secret:le(e.secret)},n=Je(t.address);return w(n)?n:t}static async generateShareKeypair(r){bt.debug(`generateAuthorKeypair("${r}")`);let e=await Le.generateKeypairBytes(),t={shareAddress:Kt(r,le(e.pubkey)),secret:le(e.secret)},n=z(t.shareAddress);return w(n)?n:t}static async sign(r,e){bt.debug("sign");try{let t=Ln(r);if(w(t))return t;let n=await Le.sign(t,e);return le(n)}catch(t){return new m("unexpected error while signing: "+t.message)}}static verify(r,e,t){bt.debug("verify");try{let n=yt(r);return w(n)?Promise.resolve(!1):Le.verify(Ye(n.pubkey),Ye(e),t)}catch{return Promise.resolve(!1)}}static async checkKeypairIsValid(r){bt.debug("checkAuthorKeypairIsValid");let e=Ir(r)?r.address:r.shareAddress;try{if(typeof e!="string"||typeof r.secret!="string")return new m("address and secret must be strings");let t=yt(e);if(w(t))return t;let n="a test message to sign. "+re(),s=await this.sign(r,n);return w(s)?s:await this.verify(e,s,n)===!1?new m("pubkey does not match secret"):!0}catch(t){return new m("unexpected error in checkAuthorKeypairIsValid: "+t.message)}}};var Dc=new C("validator es.4","red"),va=10,Aa=va*60*1e3*1e3,_n=1e13,Nn=9007199254740990,Sa=4e6,Da=53,xa=104,On={objSchema:{format:qt("es.4"),author:G({allowedChars:_t}),content:G({maxLen:Sa}),contentHash:G({allowedChars:pe,len:Da}),deleteAfter:Ke({min:_n,max:Nn,nullable:!0}),path:G({allowedChars:Ut,minLen:2,maxLen:512}),signature:G({allowedChars:pe,len:xa}),timestamp:Ke({min:_n,max:Nn}),workspace:G({allowedChars:Ot})},allowLiteralUndefined:!1,allowExtraKeys:!1},Cr,xc=(Cr=class{static hashDocument(r){let e={...r,signature:"bthisisafakesignatureusedtofillintheobjectwhenvalidatingitforhashingaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"},t=this._checkBasicDocumentValidity(e);return w(t)?Promise.resolve(t):L.sha256base32(`author	${r.author}
contentHash	${r.contentHash}
`+(r.deleteAfter===null?"":`deleteAfter	${r.deleteAfter}
`)+`format	${r.format}
path	${r.path}
timestamp	${r.timestamp}
workspace	${r.workspace}
`)}static async generateDocument({input:r,keypair:e,share:t,timestamp:n}){let s={format:"es.4",author:e.address,content:r.content,contentHash:await L.sha256base32(r.content),deleteAfter:r.deleteAfter??null,path:r.path,timestamp:n,workspace:t,signature:"?"},a=await this.signDocument(e,s);return w(a)?a:{doc:a}}static async signDocument(r,e){let t=await this.hashDocument(e);if(w(t))return t;let n=await L.sign(r,t);return w(n)?n:{...e,signature:n}}static async wipeDocument(r,e){if(e.content.length===0)return e;let t=this.removeExtraFields(e);if(w(t))return t;let s={...t.doc,content:"",contentHash:await L.sha256base32(""),signature:"?"};return this.signDocument(r,s)}static removeExtraFields(r){if(!Ze(r))return new m("doc is not a plain javascript object");let e=new Set(Object.keys(On.objSchema||{})),t={},n={};for(let[s,a]of Object.entries(r))if(e.has(s))t[s]=a;else{if(!s.startsWith("_"))return new m("extra document fields must have names starting with an underscore");n[s]=a}return{doc:t,extras:n}}static async checkDocumentIsValid(r,e){e===void 0&&(e=Date.now()*1e3);let t=this._checkBasicDocumentValidity(r);if(w(t))return t;let n=this._checkTimestampIsOk(r.timestamp,r.deleteAfter,e);if(w(n))return n;let s=this._checkAuthorCanWriteToPath(r.author,r.path);if(w(s))return s;let a=this._checkPathIsValid(r.path,r.deleteAfter);if(w(a))return a;let i=Je(r.author);if(w(i))return i;let o=z(r.workspace);if(w(o))return o;let c=await this._checkAuthorSignatureIsValid(r);if(w(c))return c;let l=await this._checkContentMatchesHash(r.content,r.contentHash);return w(l)?l:!0}static _checkBasicDocumentValidity(r){let e=Wt(On)(r);return e!==null?new m(e):!0}static _checkAuthorCanWriteToPath(r,e){return e.indexOf("~")===-1||e.indexOf("~"+r)!==-1?!0:new m(`author ${r} can't write to path ${e}`)}static _checkTimestampIsOk(r,e,t){if(r>t+Aa)return new m("timestamp too far in the future");if(e!==null){if(t>e)return new m("ephemeral doc has expired");if(e<=r)return new m("ephemeral doc expired before it was created")}return!0}static _checkPathIsValid(r,e){if(!r.startsWith("/"))return new m("invalid path: must start with /");if(r.endsWith("/"))return new m("invalid path: must not end with /");if(r.startsWith("/@"))return new m('invalid path: must not start with "/@"');if(r.indexOf("//")!==-1)return new m("invalid path: must not contain two consecutive slashes");if(e!==void 0){if(r.indexOf("!")===-1&&e!==null)return new m("when deleteAfter is set, path must contain '!'");if(r.indexOf("!")!==-1&&e===null)return new m("when deleteAfter is null, path must not contain '!'")}return!0}static async _checkAuthorSignatureIsValid(r){try{let e=await this.hashDocument(r);return w(e)?e:await L.verify(r.author,r.signature,e)!==!0?new m("signature is invalid"):!0}catch{return new m("signature is invalid (unexpected exception)")}}static async _checkContentMatchesHash(r,e){return await L.sha256base32(r)!==e?new m("content does not match contentHash"):!0}static getAttachmentInfo(r){return new m("es.4 does not support attachments")}static updateAttachmentFields(r,e,t,n){return Promise.resolve(new m("es.4 does not support attachments"))}static authorFromCredentials(r){return r.address}},Cr.id="es.4",Cr);var Mc=new C("validator es.5","red"),Ea=10,Ba=Ea*60*1e3*1e3,Un=1e13,Vn=9007199254740990,ka=8e3,Kn=53,qn=104,Ia=0,Ca=Number.MAX_SAFE_INTEGER,Wn={objSchema:{format:qt("es.5"),author:G({allowedChars:_t}),text:G({maxLen:ka}),textHash:G({allowedChars:pe,len:Kn}),deleteAfter:Ke({min:Un,max:Vn,optional:!0}),path:G({allowedChars:Ut,minLen:2,maxLen:512}),signature:G({allowedChars:pe,len:qn}),shareSignature:G({allowedChars:pe,len:qn}),timestamp:Ke({min:Un,max:Vn}),share:G({allowedChars:Ot}),attachmentSize:Ke({min:Ia,max:Ca,optional:!0}),attachmentHash:G({allowedChars:pe,len:Kn,optional:!0})},allowLiteralUndefined:!1,allowExtraKeys:!1},Fr,Qn=(Fr=class{static hashDocument(r){let e={...r,signature:"bthisisafakesignatureusedtofillintheobjectwhenvalidatingitforhashingaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",shareSignature:"bthisisafakesignatureusedtofillintheobjectwhenvalidatingitforhashingaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"},t=this._checkBasicDocumentValidity(e);return w(t)?Promise.resolve(t):L.sha256base32((r.attachmentHash===void 0?"":`attachmentHash	${r.attachmentHash}
`)+(r.attachmentSize===void 0?"":`attachmentSize	${r.attachmentSize}
`)+`author	${r.author}
`+(r.deleteAfter===void 0?"":`deleteAfter	${r.deleteAfter}
`)+`format	${r.format}
path	${r.path}
textHash	${r.textHash}
timestamp	${r.timestamp}
share	${r.share}
`)}static async generateDocument({input:r,keypair:e,share:t,timestamp:n,prevLatestDoc:s,config:a}){if(r.text===void 0&&s?.text===void 0)return new m("Couldn't determine document text from given input or previous version's text.");let i=r.text!==void 0?r.text:s?.text,o={...s,format:"es.5",author:e.address,text:i,textHash:await L.sha256base32(i),path:r.path,timestamp:n,share:t,signature:"?",shareSignature:"?"};r.deleteAfter&&(o.deleteAfter=r.deleteAfter);let c=await this.signDocument(e,o,a);return w(c)?c:r.attachment?{doc:c,attachment:r.attachment}:{doc:c}}static async signDocument(r,e,t){let n=await this.hashDocument(e);if(w(n))return n;let s=await L.sign(r,n);if(t.shareSecret===void 0)return new R(`Tried to write a document to ${e.share} without the secret.`);let a=await L.sign({shareAddress:e.share,secret:t.shareSecret},n);return w(s)?s:w(a)?a:{...e,signature:s,shareSignature:a}}static async wipeDocument(r,e,t){if(e.text.length===0)return e;let n=this.removeExtraFields(e);if(w(n))return n;let s=n.doc;if(s.attachmentHash){let i={...s,text:"",textHash:await L.sha256base32(""),signature:"?",shareSignature:"?",attachmentHash:await L.sha256base32(""),attachmentSize:0};return this.signDocument(r,i,t)}let a={...s,text:"",textHash:await L.sha256base32(""),signature:"?",shareSignature:"?"};return this.signDocument(r,a,t)}static removeExtraFields(r){if(!Ze(r))return new m("doc is not a plain javascript object");let e=new Set(Object.keys(Wn.objSchema||{})),t={},n={};for(let[s,a]of Object.entries(r))if(e.has(s))t[s]=a;else{if(!s.startsWith("_"))return new m("extra document fields must have names starting with an underscore");n[s]=a}return{doc:t,extras:n}}static async checkDocumentIsValid(r,e){e===void 0&&(e=Date.now()*1e3);let t=this._checkBasicDocumentValidity(r);if(w(t))return t;let n=this._checkTimestampIsOk(r.timestamp,r.deleteAfter?r.deleteAfter:null,e);if(w(n))return n;let s=this._checkAuthorCanWriteToPath(r.author,r.path);if(w(s))return s;let a=this._checkAttachmentFieldsConsistent(r);if(w(a))return a;let i=this._checkPathIsValid(r.path,!!r.attachmentHash,r.deleteAfter);if(w(i))return i;let o=Je(r.author);if(w(o))return o;let c=z(r.share);if(w(c))return c;let l=await this._checkAuthorSignatureIsValid(r);if(w(l))return l;let h=await this._checkShareSignatureIsValid(r);if(w(h))return h;let d=await this._checkContentMatchesHash(r.text,r.textHash);return w(d)?d:!0}static _checkBasicDocumentValidity(r){let e=Wt(Wn)(r);return e!==null?new m(e):!0}static _checkAttachmentFieldsConsistent(r){return r.text.length===0&&r.attachmentSize&&r.attachmentSize>0?new m("Documents with attachments must have text."):(r.text.length>0&&r.attachmentSize&&r.attachmentSize,r.attachmentHash&&r.attachmentSize===void 0?new m("Attachment size is undefined while attachment hash is defined"):r.attachmentSize&&r.attachmentHash===void 0?new m("Attachment hash is undefined while attachment size is defined"):!0)}static _checkAuthorCanWriteToPath(r,e){return e.indexOf("~")===-1||e.indexOf("~"+r)!==-1?!0:new m(`author ${r} can't write to path ${e}`)}static _checkTimestampIsOk(r,e,t){if(r>t+Ba)return new m("timestamp too far in the future");if(e!==null){if(t>e)return new m("ephemeral doc has expired");if(e<=r)return new m("ephemeral doc expired before it was created")}return!0}static _checkPathIsValid(r,e,t){if(!r.startsWith("/"))return new m("invalid path: must start with /");if(r.endsWith("/"))return new m("invalid path: must not end with /");if(r.startsWith("/@"))return new m('invalid path: must not start with "/@"');if(r.indexOf("//")!==-1)return new m("invalid path: must not contain two consecutive slashes");if(t!==void 0){if(r.indexOf("!")===-1&&t!==null)return new m("when deleteAfter is set, path must contain '!'");if(r.indexOf("!")!==-1&&t===null)return new m("when deleteAfter is null, path must not contain '!'")}return!jn(r)&&e?new m("when a attachment is provided, the path must end with a file extension"):jn(r)&&e===!1?new m("when no attachment is provided, the path cannot end with a file extension"):!0}static async _checkAuthorSignatureIsValid(r){try{let e=await this.hashDocument(r);return w(e)?e:await L.verify(r.author,r.signature,e)!==!0?new m("signature is invalid"):!0}catch{return new m("signature is invalid (unexpected exception)")}}static async _checkShareSignatureIsValid(r){try{let e=await this.hashDocument(r);return w(e)?e:await L.verify(r.share,r.shareSignature,e)!==!0?new m("share signature is invalid"):!0}catch{return new m("share signature is invalid (unexpected exception)")}}static async _checkContentMatchesHash(r,e){return await L.sha256base32(r)!==e?new m("content does not match contentHash"):!0}static getAttachmentInfo(r){return r.attachmentHash&&r.attachmentSize===0?new m("This document has had its attachment wiped"):!r.attachmentHash||!r.attachmentSize?new m("This document has no attachment."):{size:r.attachmentSize,hash:r.attachmentHash}}static updateAttachmentFields(r,e,t,n,s){let a={...e,attachmentHash:n,attachmentSize:t};return this.signDocument(r,a,s)}static authorFromCredentials(r){return r.address}},Fr.id="es.5",Fr),Fa=/^.*\.(\w+)$/,Ra=/^.*~@\w{4}\.\w{53}$/;function jn(r){if(r.indexOf(".")===-1)return!1;let e=r.match(Fa);return!(e===null||e[1].length===53&&r.match(Ra))}var se=Qn,Xe=[se];function Rr(r){return r||se}function Ee(r){return r||Xe}function $n(r,e){let t=[];for(let n of e)r.includes(n.id)&&t.push(n);return t}function ve(r){let e=r||Xe,t={};for(let n of e)t[n.id]=n;return t}var Ae=class{constructor(){this.deferreds=new Set;this.state="pending"}resolve(e){if(this.state==="pending"){this.state="fulfilled";for(let t of this.deferreds)t.resolve(e)}}reject(e){if(this.state==="pending"){this.state="rejected";for(let t of this.deferreds)t.reject(e)}}getPromise(){let e=T();return this.state==="fulfilled"?e.resolve():this.state==="rejected"?e.reject():this.deferreds.add(e),e}};var fe=class{constructor(e=!1){this.promises=new Set;this.sealed=!1;this.multiDeferred=new Ae;this.allowRejectedPromises=e}enrol(e){if(this.sealed)throw new R("Tried to enrol a promise when enrolment was already sealed.");this.promises.add(e),e.then(()=>{this.checkAllDone()}).catch(t=>{if(!this.allowRejectedPromises)throw t})}checkAllDone(){!this.sealed||(this.allowRejectedPromises?Promise.allSettled(this.promises).then(()=>{this.multiDeferred.resolve()}):Promise.all(this.promises).then(()=>{this.multiDeferred.resolve()}).catch(()=>{this.multiDeferred.reject()}))}seal(){this.sealed||(this.sealed=!0,this.checkAllDone())}isSealed(){return this.sealed}isDone(){return this.multiDeferred.getPromise()}};var Pr=class{constructor(){this.closed=!1;this.transform=new TransformStream({transform(e,t){t.enqueue(e)}});this.writer=this.transform.writable.getWriter();this.readable=this.transform.readable;this.writables=[]}checkClosed(){if(this.closed)throw"Closed"}getWritableStream(){this.checkClosed();let e=this.writer,t=new WritableStream({async write(n){await e.ready,await e.write(n)}});return this.writables.push(t),t}async close(){this.checkClosed();for(let e of this.writables)await e.abort();this.transform.writable.abort(),this.closed=!0}isClosed(){return this.closed}},Lr=class{constructor(){this.transformStream=new TransformStream(new Nr);this.sourceReadable=this.transformStream.readable;this.writable=this.transformStream.writable}getReadableStream(){let[e,t]=this.sourceReadable.tee();return this.sourceReadable=e,t}},Mr=class{constructor(){this.closed=!1;this.subscribers=[];this.writables=[];let e=this.subscribers;this.writable=new WritableStream({write(t){let n=e.map(({writer:s})=>new Promise(a=>{s.ready.then(()=>{s.write(t).then(a)})}));Promise.all(n)}})}checkClosed(){if(this.closed)throw"Closed"}getReadableStream(){this.checkClosed();let e=new TransformStream({transform(t,n){n.enqueue(t)}});return this.subscribers.push({transform:e,writer:e.writable.getWriter()}),e.readable}async close(){this.checkClosed();for(let e of this.writables)await e.abort();for(let{transform:e}of this.subscribers)await e.writable.abort(),await e.readable.cancel();this.closed=!0}isClosed(){return this.closed}},_r=class{constructor(e){this.closed=!1;this.combineStream=new Pr;e?this.cloneStream=new Mr:this.cloneStream=new Lr,this.combineStream.readable.pipeTo(this.cloneStream.writable)}checkClosed(){if(this.closed)throw"Closed"}getWritableStream(){return this.combineStream.getWritableStream()}getReadableStream(){return this.cloneStream.getReadableStream()}close(){this.checkClosed(),this.combineStream.close(),this.closed=!0}isClosed(){return this.closed}},et=class{constructor(){this.callbacks=new Set}onWrite(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}async write(e){for(let t of this.callbacks)await t(e)}close(){this.callbacks.clear()}},J=class{constructor(){this.callbacks=new Set;this.lock=new Tt}on(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}async send(e){for(let t of this.callbacks)await this.lock.run(()=>t(e))}},Nr=class{transform(e,t){t.enqueue(e)}},Tt=class{constructor(){this.doneEnroller=new fe;this.writable=new WritableStream({async write(e){await e()}});this.writer=this.writable.getWriter();this.closed=!1}checkClosed(){if(this.closed)throw"Closed"}async run(e){this.checkClosed(),await this.writer.ready;let t=this.writer.write(e);return this.doneEnroller.enrol(t),t}async close(){this.checkClosed(),this.doneEnroller.seal(),await this.doneEnroller.isDone(),this.writer.releaseLock(),await this.writable.abort(),this.closed=!0}isClosed(){return this.closed}},Or=class{constructor(e,t){this.channel=e,this.channelKey=t}transform(e,t){if(this.channel==="*"||this.channel===e[this.channelKey]){t.enqueue(e);return}}},$t=class{constructor(e,t){this.multistream=new _r(t),this.channelKey=e}getWritableStream(){return this.multistream.getWritableStream()}getReadableStream(e){let t=new TransformStream(new Or(e,this.channelKey));return this.multistream.getReadableStream().pipeThrough(t)}};function Ht(r,e){let t=T(),n=T(),s=()=>{if(n.state==="pending"){let a;r instanceof WebSocket?a=r:a=new WebSocket(r),n.resolve(a),a.binaryType="arraybuffer",a.readyState===a.OPEN&&t.resolve(),a.onopen=()=>{t.resolve()}}};return new WritableStream({async write(a,i){s();let o=await n;await t;try{let c=e(a);o.send(c)}catch(c){i.error(c)}o.onclose=()=>{i.error("Socket closed before we were done")}},async close(){s();let a=await n;await t,a.close()},async abort(){s();let a=await n;await t,a.close()}})}function zt(r,e){let t=T(),n=!1,s=()=>{if(t.state==="pending")if(r instanceof WebSocket)t.resolve(r);else try{let a=new WebSocket(r);t.resolve(a)}catch(a){t.reject(a)}};return new ReadableStream({async start(a){s();let i=await t;i.binaryType="arraybuffer",i.onmessage=o=>{let c=e(o);try{a.enqueue(c)}catch{}},i.onclose=()=>{if(!n)try{a.close()}catch{}},i.onerror=o=>{n=!0,a.error(o)}},async cancel(){s(),(await t).close()}})}function Hn(r){let t=r.toString(16);return t.length%2&&(t="0"+t),t}function zn(r){return BigInt("0x"+r)}var Pa={encode:{emptySet:r=>({type:"EMPTY_SET",canRespond:r}),lowerBound:r=>({type:"LOWER_BOUND",value:r}),payload:(r,e)=>({type:"PAYLOAD",payload:r,...e?{end:e}:{}}),emptyPayload:r=>({type:"EMPTY_PAYLOAD",upperBound:r}),done:r=>({type:"DONE",upperBound:r}),fingerprint:(r,e)=>({type:"FINGERPRINT",fingerprint:Hn(r),upperBound:e}),terminal:()=>({type:"TERMINAL"})},decode:{emptySet:r=>{if(r.type==="EMPTY_SET")return r.canRespond;throw"Can't decode"},lowerBound:r=>{if(r.type==="LOWER_BOUND")return r.value;throw"Can't decode"},payload:r=>{if(r.type==="PAYLOAD")return{value:r.payload,...r.end?{end:r.end}:{}};throw"Can't decode"},emptyPayload:r=>{if(r.type==="EMPTY_PAYLOAD")return r.upperBound;throw"Can't decode"},done:r=>{if(r.type==="DONE")return r.upperBound;throw"Can't decode"},fingerprint:r=>{if(r.type==="FINGERPRINT")return{fingerprint:zn(r.fingerprint),upperBound:r.upperBound};throw"Can't decode"},terminal:r=>{if(r.type==="TERMINAL")return!0;throw"Can't decode"}}},Gt=class extends ft{constructor(e,t,n){super({tree:e,encoding:Pa,fingerprintEquals:(s,a)=>s===a,payloadThreshold:t,rangeDivision:n})}};var Jt=class{constructor(e){this.statusBus=new J;this.isDoneMultiDeferred=new Ae;this.inboundEventQueue=new $;this.outboundEventQueue=new $;this.gossiperInboundQueue=new $;this.reconcilerInboundQueue=new $;this.hasPrepared=T();this.hasReconciled=T();this.hasCheckedAllExistingDocsForAttachments=T();this.requestedCount=0;this.sentDocsCount=0;this.receivedDocsCount=0;this.counterpartId=re();this.replica=e.replica,e.replica.onEvent(o=>{o.kind==="willClose"&&this.cancel()});let{treeIsReady:t}=e.syncerManager.getDocThumbnailTreeAndDocLookup(e.replica.share,Ee(e.formats));t.then(()=>{this.hasPrepared.resolve()}),(async()=>{for await(let o of this.inboundEventQueue)switch(o.kind){case"RANGE_MSG":{this.reconcilerInboundQueue.push(o.message);break}default:this.gossiperInboundQueue.push(o)}})();let n=new Kr({outboundEventQueue:this.outboundEventQueue,formats:e.formats,replica:e.replica,counterpartId:this.counterpartId,transferManager:e.transferManager,hasCheckedAllExistingDocsForAttachments:this.hasCheckedAllExistingDocsForAttachments}),s=new qr,a=new Vr({inboundEventQueue:this.reconcilerInboundQueue,outboundEventQueue:this.outboundEventQueue,syncerManager:e.syncerManager,formats:e.formats,replica:e.replica,initiateMessaging:e.initiateMessaging,wantTracker:s,payloadThreshold:e.payloadThreshold,rangeDivision:e.rangeDivision,onDocRequested:async()=>{this.requestedCount++,await this.statusBus.send(this.getStatus())}});a.isDone.then(()=>{this.hasReconciled.resolve()}),new Ur({inboundEventQueue:this.gossiperInboundQueue,outboundEventQueue:this.outboundEventQueue,syncerManager:e.syncerManager,formats:e.formats,replica:e.replica,counterpartId:this.counterpartId,transferManager:e.transferManager,cancel:this.cancel.bind(this),reconciliationIsDone:a.isDone,wantTracker:s,syncAppetite:e.syncAppetite,onDocReceived:async()=>{this.receivedDocsCount++,await this.statusBus.send(this.getStatus())},onDocSent:async()=>{this.sentDocsCount++,await this.statusBus.send(this.getStatus())},onDocRequested:async()=>{this.requestedCount++,await this.statusBus.send(this.getStatus())}}).isDone.then(async()=>{await this.hasCheckedAllExistingDocsForAttachments,this.isDoneMultiDeferred.resolve()}),this.statusBus.send(this.getStatus())}sendEvent(e){return this.inboundEventQueue.push(e)}events(){return this.outboundEventQueue}getStatus(){return{requestedCount:this.requestedCount,receivedCount:this.receivedDocsCount,sentCount:this.sentDocsCount,status:this.isDoneMultiDeferred.state==="rejected"?"aborted":this.hasPrepared.state==="pending"?"preparing":this.hasReconciled.state==="pending"?"reconciling":this.isDoneMultiDeferred.state==="fulfilled"?"done":"gossiping"}}onStatusUpdate(e){return this.statusBus.on(e)}async cancel(e){this.isDoneMultiDeferred.state==="fulfilled"||this.isDoneMultiDeferred.state==="rejected"||(this.isDoneMultiDeferred.reject(),await this.statusBus.send(this.getStatus()),this.outboundEventQueue.push({kind:"ABORT"}),this.outboundEventQueue.close(),this.inboundEventQueue.close({immediately:!0}),this.gossiperInboundQueue.close({immediately:!0}),this.reconcilerInboundQueue.close({immediately:!0}))}isDone(){return this.isDoneMultiDeferred.getPromise()}},Ur=class{constructor(e){this.isPartnerFulfilled=T();this.isFulfilled=T();let t=ve(e.formats),n=e.syncerManager.getPlumTree(e.replica.share);if(e.syncAppetite==="continuous"){let i=e.replica.getQueryStream(void 0,"new",e.formats),o=new Fe;i.pipeTo(new WritableStream({async write(c){if(c.kind==="success"&&c.sourceId!==e.counterpartId){let l=n.getMode(c.sourceId);o.reset(),o.update(`${c.doc.path} ${c.doc.author}`);let h=o.digest().toString(16),d=`${c.doc.timestamp} ${h}`;if(l==="EAGER"){let u=t[c.doc.format],p=u.getAttachmentInfo(c.doc),f=!w(p),g=!1;f&&await e.replica.getAttachment(c.doc,u)&&(g=!0),e.outboundEventQueue.push({kind:"DOC",thumbnail:d,doc:c.doc,attachmentHeld:g}),e.onDocSent()}else e.outboundEventQueue.push({kind:"HAVE",thumbnail:d})}}})).catch(()=>{})}let s=e.replica.onEvent(i=>{i.kind==="attachment_ingest"&&i.sourceId!==e.counterpartId&&e.outboundEventQueue.push({kind:"NEW_ATTACHMENT",path:i.doc.path,author:i.doc.author,format:i.doc.format,hash:i.hash})}),{lookup:a}=e.syncerManager.getDocThumbnailTreeAndDocLookup(e.replica.share,Ee(e.formats));(async()=>{for await(let i of e.inboundEventQueue)switch(i.kind){case"PRUNE":{n.onPrune(e.counterpartId);break}case"HAVE":{if(e.reconciliationIsDone.state==="fulfilled"&&e.syncAppetite==="once")break;e.wantTracker.addWantedThumbnail(i.thumbnail),n.onLazyMessage(i,o=>{e.outboundEventQueue.push({kind:"WANT",thumbnail:o})}),e.onDocRequested();break}case"WANT":{n.onGraftMessage(e.counterpartId);let[,o]=i.thumbnail.split(" "),c=a[o];if(!c)return;let[,l,h]=c,u=(await e.replica.getAllDocsAtPath(l,e.formats)).find(p=>p.author===h);if(u){let p=t[u.format],f=p.getAttachmentInfo(u),g=!w(f),A=!1;g&&await e.replica.getAttachment(u,p)&&(A=!0),e.outboundEventQueue.push({kind:"DOC",thumbnail:i.thumbnail,doc:u,attachmentHeld:A}),await e.onDocSent()}else console.error("Got a WANT event for a document not on record.");break}case"DOC":{if(this.isFulfilled.state==="fulfilled"&&e.syncAppetite==="once"||(n.onEagerMessage(e.counterpartId,i)&&e.outboundEventQueue.push({kind:"PRUNE"}),e.wantTracker.isReceived(i.thumbnail)))break;let c=t[i.doc.format];if(!c){console.error(`Was sent a doc with a format we don't know about (${i.doc.format})`);break}if(i.attachmentHeld&&await e.replica.getAttachment(i.doc,t[i.doc.format])===void 0){let h=await e.transferManager.handleDownload(i.doc,e.replica,e.counterpartId);if(w(h)){let d=c.getAttachmentInfo(i.doc);e.transferManager.registerExpectedTransfer(e.replica.share,d.hash),e.outboundEventQueue.push({kind:"WANT_ATTACHMENT",attachmentHash:d.hash,doc:i.doc,shareAddress:e.replica.share})}}await e.replica.ingest(c,i.doc,e.counterpartId),e.wantTracker.receivedWantedThumbnail(i.thumbnail),await e.onDocReceived();break}case"NEW_ATTACHMENT":{if(e.transferManager.isAlreadyQueued(i.hash,"download"))break;let o=t[i.format],l=(await e.replica.getAllDocsAtPath(i.path,[o])).find(d=>i.author===d.author);if(!l)break;if(await e.replica.getAttachment(l,t[l.format])===void 0){let d=await e.transferManager.handleDownload(l,e.replica,e.counterpartId);if(w(d)){let u=o.getAttachmentInfo(l);e.transferManager.registerExpectedTransfer(e.replica.share,u.hash),e.outboundEventQueue.push({kind:"WANT_ATTACHMENT",attachmentHash:u.hash,doc:l,shareAddress:e.replica.share})}}break}case"FULFILLED":this.isPartnerFulfilled.resolve(!0);break;case"WANT_ATTACHMENT":e.transferManager.handleUpload(i,e.replica);break;case"ABORT":await e.cancel()}})(),e.reconciliationIsDone.then(async()=>{e.syncAppetite==="once"&&(s(),e.wantTracker.seal(),await e.wantTracker.isDone(),e.outboundEventQueue.push({kind:"FULFILLED"}),this.isFulfilled.resolve())})}get isDone(){return Promise.all([this.isPartnerFulfilled,this.isFulfilled])}},Vr=class{constructor(e){this.communicationRoundsCount=0;this.isDone=T();let{tree:t,lookup:n,treeIsReady:s}=e.syncerManager.getDocThumbnailTreeAndDocLookup(e.replica.share,Ee(e.formats));e.initiateMessaging&&s.then(()=>{for(let i of a.initialMessages(o=>{let c=Date.now()-6048e5,l=o.findIndex(d=>{let[u]=d.split(" ");return parseInt(u)/1e3>c});if(l>0&&l>o.length/2)return[o.slice(0,l),o.slice(l)];let h=Math.round(o.length/2);return[o.slice(0,h),o.slice(h)]}))e.outboundEventQueue.push({kind:"RANGE_MSG",message:i})});let a=new Gt(t,e.payloadThreshold,e.rangeDivision);a.onInsertion(i=>{let[o,c]=i.split(" "),l=n[c];l&&l[0]>=parseInt(o)||(e.wantTracker.addWantedThumbnail(i),e.outboundEventQueue.push({kind:"WANT",thumbnail:i}),e.onDocRequested())}),(async()=>{await s;for await(let i of e.inboundEventQueue){if(this.isDone.state==="fulfilled")return;i.type==="TERMINAL"&&this.communicationRoundsCount++;let o=a.respond(i);for(let c of o)e.outboundEventQueue.push({kind:"RANGE_MSG",message:c})}})(),a.isDone().then(()=>{this.isDone.resolve(this.communicationRoundsCount)})}},Kr=class{constructor(e){let t=e.replica.getQueryStream({orderBy:"localIndex ASC"},"existing",e.formats),n=ve(e.formats),s=e.transferManager.handleDownload.bind(e.transferManager);t.pipeTo(new WritableStream({start(a){e.replica.onEvent(i=>{i.kind==="willClose"&&a.error()})},async write(a){if(a.kind==="existing"||a.kind==="success"){let i=n[a.doc.format],o=await e.replica.getAttachment(a.doc,i);if(w(o))return;if(o===void 0){let c=await s(a.doc,e.replica,e.counterpartId);if(w(c)){let l=i.getAttachmentInfo(a.doc);e.transferManager.registerExpectedTransfer(e.replica.share,l.hash),e.outboundEventQueue.push({kind:"WANT_ATTACHMENT",attachmentHash:l.hash,doc:a.doc,shareAddress:e.replica.share})}}}}})).then(()=>{e.hasCheckedAllExistingDocsForAttachments.resolve()}).catch(()=>{e.hasCheckedAllExistingDocsForAttachments.resolve()})}},qr=class{constructor(){this.isSealed=!1;this.wantedThumbnails=new Map;this.enroller=new fe;this.received=0;this.id=re()}addWantedThumbnail(e){if(!this.isSealed&&!this.wantedThumbnails.has(e)){let t=T();this.wantedThumbnails.set(e,t),this.enroller.enrol(t)}}receivedWantedThumbnail(e){let t=this.wantedThumbnails.get(e);t&&(t.resolve(),this.received++)}isRequested(e){return this.wantedThumbnails.has(e)}isReceived(e){let t=this.wantedThumbnails.get(e);return t?t.state==="fulfilled":!1}seal(){this.enroller.seal()}isDone(){return this.enroller.isDone()}get requestedCount(){return this.wantedThumbnails.size}get receivedCount(){return this.received}};var tt=class{constructor(e,t){this.closed=!1;this.cb=e,this.ms=t,this.timeout=setTimeout(e,t)}bump(){this.closed||(clearTimeout(this.timeout),this.timeout=setTimeout(this.cb,this.ms))}close(){this.closed=!0,clearTimeout(this.timeout)}};var rt=class{constructor({stream:e,replica:t,doc:n,format:s,requester:a,counterpartId:i}){this.status="ready";this.loaded=0;this.statusBus=new J;this.transferOp=T();this.multiDeferred=new Ae;this.sourceDoc=n,this.share=t.share,this.requester=a;let o=s.getAttachmentInfo(n);if(w(o))throw new m("AttachmentTransfer was given a doc which has no attachment!");this.hash=o.hash,this.expectedSize=o.size;let c=this.updateLoaded.bind(this);if(e instanceof ReadableStream){this.kind="download";let l;this.abortCb=()=>{l?l.cancel():e.cancel()};let h=null,d=new ReadableStream({async start(u){let p=e.getReader();for(l=p,h=new tt(()=>{u.error("Attachment download timed out.")},1e4);;){let{done:f,value:g}=await p.read();if(h.bump(),f)break;c(g.byteLength),u.enqueue(g)}h.close(),u.close()}});this.transferOp.resolve(()=>{let u=T();return t.ingestAttachment(s,n,d,i).then(p=>{if(w(p)&&this.loaded===0){this.changeStatus("missing_attachment");return}if(w(p)){console.warn(`Couldn't ingest the attachment for ${n.path} by ${n.author}: ${p.message}`),u.reject(p);return}u.resolve()}).catch(p=>{u.reject(p)}),u})}else this.kind="upload",this.abortCb=()=>{e.abort().catch(()=>{})},t.getAttachment(n,s).then(async l=>{if(!l){await this.changeStatus("missing_attachment"),await e.abort();return}if(w(l)){await this.changeStatus("failed"),await e.abort();return}let h=new TransformStream({transform(d,u){c(d.byteLength),u.enqueue(d)}});this.transferOp.resolve(()=>l.stream().then(d=>d.pipeThrough(h).pipeTo(e)))})}async start(){if(this.status!=="ready")return;let e=await this.transferOp;await this.changeStatus("in_progress"),e().then(async()=>{await this.changeStatus("complete")}).catch(async()=>{await this.changeStatus("failed")})}updateLoaded(e){this.loaded+=e,this.statusBus.send({status:this.status,bytesLoaded:this.loaded,totalBytes:this.expectedSize})}async changeStatus(e){this.status==="complete"||this.status==="failed"||this.status==="missing_attachment"||(this.status=e,await this.statusBus.send({status:e,bytesLoaded:this.loaded,totalBytes:this.expectedSize}),e==="complete"&&this.multiDeferred.resolve(),e==="failed"&&this.multiDeferred.reject("Attachment transfer failed"),e==="missing_attachment"&&this.multiDeferred.reject("The other peer does not have this attachment"))}get doc(){return this.sourceDoc}onProgress(e){return this.statusBus.on(e)}abort(){this.abortCb()}isDone(){return this.multiDeferred.getPromise()}};var Zt=class{constructor(e){this.waiting=[];this.active=new Set;this.failed=new Set;this.completed=new Set;this.transfersRequestedByUsEnroller=new fe(!0);this.reports={};this.reportBus=new J;this.activeLimit=e}async activate(e){this.active.add(e),e.isDone().then(()=>{this.completed.add(e)}).catch(()=>{this.failed.add(e)}).finally(()=>{this.active.delete(e),this.admitNext()}),await e.start()}queue(e){this.waiting.push(e)}admitNext(){if(this.waiting.length===0||this.active.size>=this.activeLimit)return;let e=this.waiting.shift();e&&this.activate(e)}async addTransfer(e){e.onProgress(()=>{this.updateTransferStatus(e)}),e.requester==="us"&&this.transfersRequestedByUsEnroller.enrol(e.isDone()),this.active.size<this.activeLimit?await this.activate(e):this.queue(e)}gotAllTransfersRequestedByUs(){this.transfersRequestedByUsEnroller.seal()}cancel(){this.transfersRequestedByUsEnroller.seal();for(let e of this.active)e.abort()}updateTransferStatus(e){this.reports[e.share]||(this.reports[e.share]={}),this.reports[e.share][e.hash+e.kind]={author:e.doc.author,path:e.doc.path,format:e.doc.format,hash:e.hash,kind:e.kind,status:e.status,bytesLoaded:e.loaded,totalBytes:e.expectedSize},this.reportBus.send(this.getReport())}getReport(){let e={};for(let t in this.reports){let n=[],s=this.reports[t];for(let a in s){let i=s[a];n.push(i)}e[t]=n}return e}hasQueuedTransfer(e,t){for(let n of this.waiting)if(n.hash===e&&n.kind===t)return!0;for(let n of this.active)if(n.hash===e&&n.kind===t)return!0;for(let n of this.completed)if(n.hash===e&&n.kind===t)return!0;return!1}onReportUpdate(e){return this.reportBus.on(e)}transfersRequestedByUsFinished(){return this.transfersRequestedByUsEnroller.isDone()}};var Yt=class{constructor(e){this.otherSyncerId=T();this.receivedAllExpectedTransfersEnroller=new fe;this.madeAllAttachmentRequestsEnroller=new fe(!0);this.reportDidUpdateBus=new J;this.expectedTransferPromises=new Map;this.partner=e.partner,this.queue=new Zt(this.partner.concurrentTransfers),this.formats=e.formats,this.formatsLookup=ve(this.formats),this.queue.onReportUpdate(async t=>{await this.reportDidUpdateBus.send(t)}),this.madeAllAttachmentRequestsEnroller.isDone().then(()=>{this.receivedAllExpectedTransfersEnroller.seal()}),this.receivedAllExpectedTransfersEnroller.isDone().then(()=>{this.queue.gotAllTransfersRequestedByUs()})}registerSyncAgent(e){this.madeAllAttachmentRequestsEnroller.enrol(e.isDone())}allSyncAgentsKnown(){this.madeAllAttachmentRequestsEnroller.seal()}registerExpectedTransfer(e,t){let n=`${e}_${t}`;if(this.expectedTransferPromises.has(n))return;let s=T();this.expectedTransferPromises.set(n,s),this.receivedAllExpectedTransfersEnroller.enrol(s)}async queueTransfer(e){this.queue.hasQueuedTransfer(e.hash,e.kind)||await this.queue.addTransfer(e)}async handleDownload(e,t,n){let s=this.formatsLookup[e.format],a=s.getAttachmentInfo(e);if(w(a))throw new R("TransferManager: attempted to download doc with no attachment.");let i=await this.partner.getDownload({doc:e,shareAddress:t.share,syncerId:await this.otherSyncerId,attachmentHash:a.hash});if(i===void 0)return"no_attachment";if(w(i))return i;let o=new rt({replica:t,doc:e,format:s,stream:i,requester:"us",counterpartId:n});return await this.queueTransfer(o),"queued"}async handleUpload(e,t){let n=this.formatsLookup[e.doc.format];if(!await t.getAttachment(e.doc,n))return!1;let a=await this.partner.handleUploadRequest({shareAddress:e.shareAddress,syncerId:await this.otherSyncerId,doc:e.doc,attachmentHash:e.attachmentHash});if(w(a))return!1;try{let i=new rt({doc:e.doc,format:n,replica:t,stream:a,requester:"them",counterpartId:"unused"});await this.queueTransfer(i)}catch{return!1}return!0}async handleTransferRequest({replica:e,path:t,author:n,source:s,kind:a,formatName:i,counterpartId:o}){let c=await this.partner.handleTransferRequest(s,a);if(c===void 0||w(c))return;let l=ve(this.formats)[i];if(!l)return;let d=(await e.getAllDocsAtPath(t,[l])).find(p=>p.author===n);if(!d)return;let u=new rt({doc:d,format:l,replica:e,stream:c,requester:a==="upload"?"us":"them",counterpartId:o});if(u.requester==="us"){let p=`${u.share}_${u.hash}`,f=this.expectedTransferPromises.get(p);f&&f.resolve()}await this.queueTransfer(u)}cancel(){this.queue.cancel()}getReport(){return this.queue.getReport()}onReportUpdate(e){return this.reportDidUpdateBus.on(e)}transfersRequestedByUsFinished(){return this.queue.transfersRequestedByUsFinished()}registerOtherSyncerId(e){this.otherSyncerId.resolve(e)}isAlreadyQueued(e,t){return this.queue.hasQueuedTransfer(e,t)}};var nt=class{constructor(e){this.id=re();this.syncAgents=new Map;this.syncAgentQueues=new Map;this.statusBus=new J;this.partnerIsFulfilled=T();this.isDoneMultiDeferred=new Ae;this.manager=e.manager,this.peer=e.manager.peer,this.appetite=e.partner.syncAppetite,this.formats=Ee(e.formats),this.partner=e.partner,this.transferManager=new Yt({partner:this.partner,formats:this.formats}),this.transferManager.onReportUpdate(async()=>{await this.statusBus.send(this.getStatus())}),this.heartbeatInterval=setInterval(()=>{this.partner.sendEvent({kind:"HEARTBEAT"})},1e3),(async()=>{try{for await(let n of e.partner.getEvents())this.handleIncomingEvent(n)}catch(n){this.cancel(n||"Partner disconnected")}})();let t=re();Promise.all(this.peer.shares().map(n=>Xt(t,n))).then(n=>{this.partner.sendEvent({kind:"DISCLOSE",salt:t,syncerId:this.id,shares:n,formats:this.formats?this.formats.map(s=>s.id):[se.id],canRespond:!1})}),this.transferManager.transfersRequestedByUsFinished().then(async()=>{e.partner.syncAppetite!=="continuous"&&(await this.partner.sendEvent({kind:"SYNCER_FULFILLED"}),await this.partnerIsFulfilled,clearInterval(this.heartbeatInterval),await this.partner.closeConnection(),this.bumpingTimeout.close(),this.isDoneMultiDeferred.resolve())}),this.peer.onReplicasChange(async n=>{if(this.appetite==="once")return;let s=Array.from(n.keys());for(let[i,o]of this.syncAgents)s.includes(i)===!1&&(await o.cancel("Replica was removed from peer."),this.syncAgents.delete(i));let a=re();Promise.all(s.map(i=>Xt(a,i))).then(i=>{this.partner.sendEvent({kind:"DISCLOSE",salt:a,syncerId:this.id,shares:i,formats:this.formats?this.formats.map(o=>o.id):[se.id],canRespond:!0})})}),this.bumpingTimeout=new tt(()=>{this.cancel("No communication from the other peer in the last three seconds.")},1e4)}addShare(e,t,n){if(this.syncAgents.has(e))return;let s=this.peer.getReplica(e);if(!s){console.error("Couldn't get the replica for a share we had in common.");return}let a=new Jt({replica:s,formats:t,syncerManager:this.manager,transferManager:this.transferManager,initiateMessaging:n,payloadThreshold:this.partner.payloadThreshold,rangeDivision:this.partner.rangeDivision,syncAppetite:this.appetite});a.onStatusUpdate(()=>{this.statusBus.send(this.getStatus())}),this.syncAgents.set(e,a),this.transferManager.registerSyncAgent(a);let i=this.syncAgentQueues.get(e),o;if(i)o=i;else{let c=new $;o=c,this.syncAgentQueues.set(e,c)}(async()=>{for await(let c of o)a.sendEvent(c)})(),(async()=>{for await(let c of a.events())this.partner.sendEvent({to:e,...c})})()}async handleIncomingEvent(e){switch(this.bumpingTimeout.bump(),e.kind){case"DISCLOSE":{let t=$n(e.formats,this.formats);if(t.length===0)break;let n=new Set(e.shares),s=new Set,a=new Set;for(let o of this.peer.shares()){let c=await Xt(e.salt,o);n.has(c)?s.add(o):a.add(o)}let i=this.id>e.syncerId;for(let o of s)this.addShare(o,t,i);for(let o of a){let c=this.syncAgents.get(o);c&&(c.cancel("No longer in common with the other peer."),this.syncAgents.delete(o))}if(this.transferManager.registerOtherSyncerId(e.syncerId),this.appetite==="once"&&this.transferManager.allSyncAgentsKnown(),e.canRespond){let o=re();Promise.all(this.peer.shares().map(c=>Xt(o,c))).then(c=>{this.partner.sendEvent({kind:"DISCLOSE",salt:o,syncerId:this.id,shares:c,formats:this.formats?this.formats.map(l=>l.id):[se.id],canRespond:!1})})}s.size===0&&this.appetite==="once"&&this.partner.sendEvent({kind:"SYNCER_FULFILLED"});break}case"SYNCER_FULFILLED":{this.partnerIsFulfilled.resolve();break}case"HEARTBEAT":break;default:{let{to:t}=e,n=this.syncAgentQueues.get(t);if(!n){let s=new $;s.push(e),this.syncAgentQueues.set(t,s);break}n.push(e)}}}getStatus(){let e={};for(let[t,n]of this.syncAgents)e[t]={docs:n.getStatus(),attachments:this.transferManager.getReport()[t]||[]};return e}onStatusChange(e){return this.statusBus.on(e)}async cancel(e){this.bumpingTimeout.close(),this.isDoneMultiDeferred.reject(e);for(let[t,n]of this.syncAgents)await n.cancel();clearInterval(this.heartbeatInterval),this.transferManager.cancel(),await this.partner.closeConnection()}handleTransferRequest({shareAddress:e,path:t,author:n,source:s,kind:a,formatName:i}){if(this.isDoneMultiDeferred.state==="rejected")return;let o=this.peer.getReplica(e);if(!o)return;let c="unused";if(a==="upload"){let l=this.syncAgents.get(e);l&&(c=l.counterpartId)}return this.transferManager.handleTransferRequest({replica:o,author:n,formatName:i,kind:a,path:t,source:s,counterpartId:c})}isDone(){return this.isDoneMultiDeferred.getPromise()}};function Xt(r,e){return L.sha256base32(r+e+r)}var er=class{constructor(e,t,n,s){this.concurrentTransfers=1024;this.payloadThreshold=1;this.rangeDivision=2;this.outgoingQueue=new $;this.incomingQueue=new $;this.syncAppetite=n,this.partnerPeer=e;let{incomingQueue:a,outgoingQueue:i}=this;this.partnerSyncer=new nt({manager:e.syncerManager,formats:s,partner:{syncAppetite:n,getEvents(){return a},sendEvent(o){return i.push(o),Promise.resolve()},concurrentTransfers:1024,payloadThreshold:32,rangeDivision:32,async getDownload(o){let c=t.getReplica(o.shareAddress);if(!c)throw new m("Tried to get a receiving transfer for an unknown share.");let l=await c.replicaDriver.attachmentDriver.getAttachment(o.doc.format,o.attachmentHash);if(!!l&&!w(l))return await l.stream()},closeConnection(){return i.close(),Promise.resolve()},handleUploadRequest(o){return Promise.resolve(new ce("PartnerLocal does not support uploads."))},handleTransferRequest(o,c){return Promise.resolve(new ce("PartnerLocal does not support transfer requests."))}}})}getEvents(){return this.outgoingQueue}sendEvent(e){return this.incomingQueue.push(e),Promise.resolve()}closeConnection(){return this.incomingQueue.close(),Promise.resolve()}async getDownload(e){let t=this.partnerPeer.getReplica(e.shareAddress);if(!t)throw new m("Tried to get a receiving transfer for an unknown share.");let n=await t.replicaDriver.attachmentDriver.getAttachment(e.doc.format,e.attachmentHash);if(!!n&&!w(n))return await n.stream()}handleUploadRequest(e){return Promise.resolve(new ce("PartnerLocal does not support uploads."))}handleTransferRequest(e,t){return Promise.resolve(new ce("PartnerLocal does not support transfer requests."))}};var Gn=class{constructor({socket:e,appetite:t}){this.concurrentTransfers=16;this.payloadThreshold=8;this.rangeDivision=8;this.incomingQueue=new $;this.socketIsReady=T();this.syncAppetite=t,e.readyState===e.OPEN&&this.socketIsReady.resolve(),e.onopen=()=>{this.socketIsReady.resolve()},this.socket=e,this.socket.binaryType="arraybuffer",this.socket.onmessage=n=>{this.incomingQueue.push(JSON.parse(n.data))},this.socket.onclose=()=>{this.incomingQueue.close()},this.socket.onerror=n=>{if("error"in n){this.incomingQueue.close({withError:n.error});return}this.incomingQueue.close({withError:new R("Websocket error.")})}}async sendEvent(e){if(await this.socketIsReady,this.socket.readyState===this.socket.OPEN)return this.socket.send(JSON.stringify(e))}getEvents(){return this.incomingQueue}closeConnection(){return this.socket.close(),Promise.resolve()}getDownload(e){return Promise.resolve(new ce("SyncDriverWebServer does not support download requests."))}handleUploadRequest(e){return Promise.resolve(new ce("SyncDriverWebServer does not support upload requests."))}handleTransferRequest(e,t){if(t==="download"){let n=Ht(e,s=>s);return Promise.resolve(n)}else{let n=zt(e,s=>s.data instanceof ArrayBuffer?new Uint8Array(s.data):null);return Promise.resolve(n)}}};var tr=class{constructor(e){this.concurrentTransfers=16;this.payloadThreshold=8;this.rangeDivision=8;this.incomingQueue=new $;this.socketIsReady=T();this.syncAppetite=e.appetite;let t=new URL(e.url),n=`${t.host}${t.pathname==="/"?"":t.pathname}`;this.isSecure=t.protocol==="https:"||t.protocol==="wss:",this.wsUrl=`${this.isSecure?"wss://":"ws://"}${n}/'`;let s=new URL(e.appetite,this.wsUrl);this.socket=new WebSocket(s.toString()),this.socket.onopen=()=>{this.socketIsReady.resolve()},this.socket.binaryType="arraybuffer",this.socket.onmessage=a=>{this.incomingQueue.push(JSON.parse(a.data))},this.socket.onclose=()=>{this.incomingQueue.close()},this.socket.onerror=a=>{if("error"in a){this.incomingQueue.close({withError:a.error});return}this.incomingQueue.close({withError:new R("Websocket error.")})}}async sendEvent(e){if(await this.socketIsReady,!(this.socket.readyState===this.socket.CLOSED||this.socket.readyState===this.socket.CLOSING))return this.socket.send(JSON.stringify(e))}getEvents(){return this.incomingQueue}closeConnection(){return this.socket.close(),Promise.resolve()}getDownload(e){let t=new URL(`${e.syncerId}/download/${e.shareAddress}/${e.doc.format}/${e.doc.author}${e.doc.path}`,this.wsUrl),n=zt(t.toString(),s=>s.data instanceof ArrayBuffer?new Uint8Array(s.data):null);return Promise.resolve(n)}handleUploadRequest(e){let t=new URL(`${e.syncerId}/upload/${e.shareAddress}/${e.doc.format}/${e.doc.author}${e.doc.path}`,this.wsUrl),n=Ht(t.toString(),s=>s);return Promise.resolve(n)}handleTransferRequest(e,t){return Promise.resolve(new ce("SyncDriverWebClient does not support external transfer requests."))}};function La(r,e){let[t,n]=r.split(" "),[s,a]=e.split(" "),i=parseInt(t),o=parseInt(s);return i>o?1:i<o?-1:n>a?1:n<a?-1:0}var Ma={lift:r=>br(r),combine:(r,e)=>r+e,neutral:BigInt(0)},rr=class extends pt{constructor(){super(Ma,La)}};var nr=class{constructor(){this.messagingModes=new Map;this.eagerMessageThumbnails=new Set;this.haveTimeouts=new Map}getMode(e){let t=this.messagingModes.get(e);if(t)return t;let n=this.messagingModes.size===0?"EAGER":"LAZY";return this.messagingModes.set(e,n),"EAGER"}onEagerMessage(e,t){let n=this.haveTimeouts.get(t.thumbnail);return n?(clearTimeout(n),!1):this.eagerMessageThumbnails.has(t.thumbnail)?(this.messagingModes.set(e,"LAZY"),!0):(this.eagerMessageThumbnails.add(t.thumbnail),!1)}onLazyMessage(e,t){if(!this.haveTimeouts.has(e.thumbnail)){let n=setTimeout(()=>{t(e.thumbnail)},5);this.haveTimeouts.set(e.thumbnail,n)}}onGraftMessage(e){this.messagingModes.set(e,"EAGER")}onPrune(e){this.messagingModes.set(e,"LAZY")}};var sr=class{constructor(e){this.syncers=new Map;this.syncerEventBus=new J;this.docThumbnailTreeAndLookup=new Map;this.hasher=new Fe;this.plumTrees=new Map;this.peer=e}addPartner(e,t,n){let s=new nt({manager:this,partner:e,formats:n});return this.syncers.set(s.id,{syncer:s,description:t}),this.syncerEventBus.send(this.syncers),s}getSyncers(){return this.syncers}getDocThumbnailTreeAndDocLookup(e,t){let n=t.map(u=>u.id),s=`${e} ${n}`,a=this.docThumbnailTreeAndLookup.get(s);if(a){let[u,p]=a;return{tree:u,lookup:p,treeIsReady:Promise.resolve(!0)}}let i=this.peer.getReplica(e);if(!i)throw new R("A DocThumbnailTree was requested for a share the peer doesn't know about, big problem!");let o=this.hasher,c=i.getQueryStream({historyMode:"all",orderBy:"localIndex ASC"},"everything",t),l=new rr,h={},d=T();return c.pipeTo(new WritableStream({write(u){if(u.kind==="processed_all_existing"){d.resolve();return}o.reset(),o.update(`${u.doc.path} ${u.doc.author}`);let p=o.digest().toString(16),f=`${u.doc.timestamp} ${p}`;(u.kind==="existing"||u.kind==="success")&&(h[p]=[u.doc.timestamp,u.doc.path,u.doc.author],l.insert(f)),u.kind==="expire"&&(delete h[p],l.remove(f))}})),{tree:l,lookup:h,treeIsReady:d}}getPlumTree(e){let t=this.plumTrees.get(e);if(t)return t;let n=new nr;return this.plumTrees.set(e,n),n}onSyncersChange(e){return this.syncerEventBus.on(e)}};var qe=new C("peer","orangeRed"),vt=JSON.stringify,st=class{constructor(){this.replicaEventBus=new J;this.replicaMap=new Map;qe.debug("constructor"),this.syncerManager=new sr(this)}hasShare(e){return this.replicaMap.has(e)}shares(){let e=[...this.replicaMap.keys()];return e.sort(),e}replicas(){let e=[...this.replicaMap.keys()];return e.sort(),e.map(t=>this.replicaMap.get(t))}size(){return this.replicaMap.size}getReplica(e){return this.replicaMap.get(e)}async addReplica(e){if(qe.debug(`addReplica(${vt(e.share)})`),this.replicaMap.has(e.share))throw qe.debug("already had a replica with that share"),new Error(`Peer.addReplica: already has a replica with share ${vt(e.share)}.  Don't add another one.`);this.replicaMap.set(e.share,e),await this.replicaEventBus.send(this.replicaMap),qe.debug("    ...addReplica: done")}async removeReplicaByShare(e){qe.debug(`removeReplicaByShare(${vt(e)})`),this.replicaMap.delete(e),await this.replicaEventBus.send(this.replicaMap)}async removeReplica(e){let t=this.replicaMap.get(e.share);e===t?(qe.debug(`removeReplica(${vt(e.share)})`),await this.removeReplicaByShare(e.share)):qe.debug(`removeReplica(${vt(e.share)}) -- same share but it's a different instance now; ignoring`)}sync(e,t=!1,n){try{let s=new tr({url:e,appetite:t?"continuous":"once"});return this.syncerManager.addPartner(s,e,n)}catch{if(e instanceof st){let s=new er(e,this,t?"continuous":"once",n);return this.syncerManager.addPartner(s,"Local",n)}console.error("Provided an invalid target for syncing to a peer:",e);return}}addSyncPartner(e,t,n){return this.syncerManager.addPartner(e,t,n)}getSyncers(){return this.syncerManager.getSyncers()}onReplicasChange(e){return this.replicaEventBus.on(e)}onSyncersChange(e){return this.syncerManager.onSyncersChange(e)}};var Jn={historyMode:"latest",orderBy:"path ASC",startAfter:void 0,limit:void 0,filter:void 0,formats:["es.5"]};var We=new C("query","green");function at(r){let e={...Jn,...r},t={query:{limit:0},isValid:!1,willMatch:"nothing"};if(e.limit!==void 0&&e.limit<0)return We.debug("cleanUpQuery: unreasonable limit - returning empty invalid query",t),t;if(e.orderBy?.startsWith("path")&&e.startAfter?.localIndex!==void 0)return We.debug('cleanUpQuery: orderBy is "path" but startAfter is not compatible - returning empty invalid query',t),t;if(e.orderBy?.startsWith("localIndex")&&e.startAfter?.path!==void 0)return We.debug('cleanUpQuery: orderBy is "localIndex" but startAfter is not compatible - returning empty invalid query',t),t;if(e.historyMode!==void 0&&e.historyMode!=="all"&&e.historyMode!=="latest")return We.debug(`cleanUpQuery: unknown historyMode ${JSON.stringify(e.historyMode)} - returning empty invalid query`,t),t;if(e.orderBy!==void 0&&["path ASC","path DESC","localIndex ASC","localIndex DESC"].indexOf(e.orderBy)===-1)return We.debug(`cleanUpQuery: unrecognized orderBy value ${JSON.stringify(e.orderBy)} - returning empty invalid query`,t),t;let n=e.historyMode==="all"?"all":"all-latest";if(e.filter!==void 0&&!we(e.filter,{})&&(n="some"),e.startAfter!==void 0&&!we(e.startAfter,{})&&(n="some"),e.limit!==void 0&&(e.limit>0&&(n="some"),e.limit===0&&(n="nothing")),e.filter!==void 0){let s=e.filter;s.path&&s.pathStartsWith&&!s.path.startsWith(s.pathStartsWith)&&(n="nothing"),s.path&&s.pathEndsWith&&!s.path.endsWith(s.pathEndsWith)&&(n="nothing"),s.timestamp&&s.timestampGt&&!(s.timestamp>s.timestampGt)&&(n="nothing"),s.timestamp&&s.timestampLt&&!(s.timestamp<s.timestampLt)&&(n="nothing"),s.timestampGt&&s.timestampLt&&!(s.timestampLt+1<s.timestampGt)&&(n="nothing")}if(n==="nothing"){let s={query:{limit:0},isValid:!0,willMatch:"nothing"};return We.debug("cleanUpQuery - this query will match nothing, so returning a simpler query that also matches nothing",s),s}return We.debug(`cleanUpQuery - query is ok!  willMatch = ${n}`),{query:e,isValid:!0,willMatch:n}}function Me(r,e){return!(e.path!==void 0&&r.path!==e.path||e.pathStartsWith!==void 0&&!r.path.startsWith(e.pathStartsWith)||e.pathEndsWith!==void 0&&!r.path.endsWith(e.pathEndsWith)||e.author!==void 0&&r.author!==e.author||e.timestamp!==void 0&&r.timestamp!==e.timestamp||e.timestampGt!==void 0&&!(r.timestamp>e.timestampGt)||e.timestampLt!==void 0&&!(r.timestamp<e.timestampLt))}function Zn(r,e){return r.deleteAfter===null||r.deleteAfter===void 0?!1:(e||Date.now()*1e3)>r.deleteAfter}var Fu=new C("query helpers","gold"),_a=/[.*+?^${}()|[\]\\]/g;function Na(r){return r.replace(_a,"\\$&")}var Oa=(r,e)=>{if(r.flags.indexOf("g")===-1)throw new TypeError('matchAll requires a regex with the "g" flag set');let t=[],n;for(;(n=r.exec(e))!==null;)t.push(n);return t},At=(r,e=!0)=>{if(r.indexOf("***")!==-1)throw new m("invalid glob query has three stars in a row: "+r);let t=wt(r,"**",";");return t=wt(t,"*","#"),t=Na(t),t=wt(t,";",".*"),t=wt(t,"#","[^/]*"),e&&(t="^"+t+"$"),t},Yn=r=>{if(r.indexOf("*")===-1)return{query:{filter:{path:r}},regex:null};let e=r.split("*"),t=e[0],n=e[e.length-1],s={},a={};t&&(s.pathStartsWith=t),n&&(s.pathEndsWith=n);let i="?";if(e.length===3){let[o,c,l]=e;o===""&&c===""&&(i=null),c===""&&l===""&&(i=null)}return i==="?"&&(i=At(r)),Pn(s)||(a.filter=s),{query:a,regex:i}};async function Ru(r,e,t={},n){let{query:s,regex:a}=Yn(e);s={...s,...t};let i=await r.queryDocs(s,n);if(a!==null){let o=new RegExp(a);i=i.filter(c=>o.test(c.path))}return i}function Xn(r){if(r.indexOf("}{")!==-1)throw new m("template is not allowed to have to adjacent variables {like}{this}");if(r.indexOf("*{")!==-1||r.indexOf("}*")!==-1)throw new m("template cannot have a star touching a variable *{likeThis}");let e=kr(r,"{"),t=kr(r,"}");if(e!==t)throw new m("unbalanced curly braces");let n=/\{(.*?)\}/g,s=/^[a-zA-Z_][a-zA-Z0-9_]*$/,a=Oa(n,r),i=a.map(d=>d[1]);for(let d of i)if(!s.test(d))throw new m("variable name in template is not valid.  can only contain alphanumeric and underscore, and not start with number");if(e!==i.length||t!==i.length)throw new m("weird curly brace mismatch, maybe }backwards{");if(new Set(i).size!==i.length)throw new m("variable names may not be repeated");let c=r.replace(n,"*"),l=[];a.length===0&&l.push(At(r,!1));for(let d=0;d<a.length;d++){let u=a[d],p=u[1],f=u.index,g=u.index+u[0].length;if(d===0){let E=r.slice(0,f);l.push(At(E,!1))}let A="(?<"+p+">[^/]*)";if(l.push(A),d<=a.length-2){let E=a[d+1],_=r.slice(g,E.index);l.push(At(_,!1))}else{let E=r.slice(g);l.push(At(E,!1))}}let h="^"+l.join("")+"$";return{template:r,varNames:i,glob:c,namedCaptureRegex:h}}var Ua=(r,e)=>{let t=e.match(new RegExp(r));return t===null?null:{...t.groups}},Pu=(r,e)=>{if(r.indexOf("{")===-1&&r.indexOf("}")===-1)return r===e?{}:null;let{namedCaptureRegex:t}=Xn(r);return Ua(t,e)},Lu=(r,e)=>{for(let[t,n]of Object.entries(r))e=e.replace("{"+t+"}",n);return e};async function Mu(r,e,t={},n){let{glob:s}=Xn(e),{query:a,regex:i}=Yn(s);a={...a,...t};let o=await r.queryDocs(a,n);if(i!=null){let c=new RegExp(i);o=o.filter(l=>c.test(l.path))}return o}var jr=(n=>(n[n.LT=-1]="LT",n[n.EQ=0]="EQ",n[n.GT=1]="GT",n))(jr||{});function es(r){return r.sort(),r}function ar(r,e,t="ASC"){if(Array.isArray(r)&&_e(r,e))return 0;if(typeof r=="object"&&we(r,e))return 0;if(r===e)return 0;if(t==="ASC"||t===void 0)return r<e?-1:1;if(t==="DESC")return r>e?-1:1;throw new Error("unexpected sort order to compareBasic: "+JSON.stringify(t))}function Be(r,e,t){let n=Math.min(r.length,e.length);for(let i=0;i<n;i++){let o=t?.[i]??"ASC",c=ar(r[i],e[i],o);if(c!==0)return c}if(r.length===e.length)return 0;let s=Math.min(r.length,e.length),a=t?.[s]??"ASC";return ar(r.length,e.length,a)}function it(r,e="ASC"){return(t,n)=>ar(t[r],n[r],e)}function Vu(r){return(e,t)=>ar(r(e),r(t))}function Ku(r){return(e,t)=>Be(r(e),r(t))}var Va=JSON.stringify,ee=new C("replica","gold"),te=new C("replica set","gold"),Z=new C("replica ingest","gold");function ts(r,e){return Be([r.timestamp,r.signature],[e.timestamp,r.signature],["DESC","ASC"])}var ir=class{constructor({driver:e,config:t}){this._isClosed=!1;this.ingestLockStream=new Tt;this.eventMultiStream=new $t("kind",!0);this.callbackSink=new et;this.expireEventTimeouts=new Map;let n=z(e.docDriver.share);if(w(n))throw n;ee.debug(`constructor.  driver = ${e?.constructor?.name}`),this.replicaId="replica-"+re(),this.share=e.docDriver.share,this.replicaDriver=e,this.formatsConfig=t||{},this.eventWriter=this.eventMultiStream.getWritableStream().getWriter(),this.eventMultiStream.getReadableStream("*").pipeTo(new WritableStream(this.callbackSink)),this.eraseInterval=setInterval(()=>{this.isClosed()?clearInterval(this.eraseInterval):this.pruneExpiredDocsAndAttachments()},1e3*60*60)}isClosed(){return this._isClosed}async close(e){if(ee.debug("closing..."),this._isClosed)throw new v;await this.ingestLockStream.close();for(let t of this.expireEventTimeouts.values())clearTimeout(t);return ee.debug("    sending willClose blockingly..."),await this.eventWriter.write({kind:"willClose"}),ee.debug("    marking self as closed..."),e===!1&&await this.pruneExpiredDocsAndAttachments(),await this.replicaDriver.attachmentDriver.clearStaging(),this._isClosed=!0,ee.debug(`    closing ReplicaDriver (erase = ${e})...`),await this.replicaDriver.docDriver.close(e),await this.replicaDriver.attachmentDriver.close(e),clearInterval(this.eraseInterval),ee.debug("    sending didClose nonblockingly..."),await this.eventWriter.write({kind:"didClose"}),ee.debug("...closing done"),Promise.resolve()}async getConfig(e){if(this._isClosed)throw new v;return await this.replicaDriver.docDriver.getConfig(e)}async setConfig(e,t){if(this._isClosed)throw new v;return await this.replicaDriver.docDriver.setConfig(e,t)}async listConfigKeys(){if(this._isClosed)throw new v;return await this.replicaDriver.docDriver.listConfigKeys()}async deleteConfig(e){if(this._isClosed)throw new v;return await this.replicaDriver.docDriver.deleteConfig(e)}getMaxLocalIndex(){if(this._isClosed)throw new v;return this.replicaDriver.docDriver.getMaxLocalIndex()}getAllDocs(e){return ee.debug("getAllDocs()"),this.queryDocs({historyMode:"all",orderBy:"path ASC"},e)}getLatestDocs(e){return ee.debug("getLatestDocs()"),this.queryDocs({historyMode:"latest",orderBy:"path ASC"},e)}getAllDocsAtPath(e,t){return ee.debug(`getAllDocsAtPath("${e}")`),this.queryDocs({historyMode:"all",orderBy:"path ASC",filter:{path:e}},t)}async getLatestDocAtPath(e,t){ee.debug(`getLatestDocsAtPath("${e}")`);let n=await this.queryDocs({historyMode:"latest",orderBy:"path ASC",filter:{path:e}},t?[t]:void 0);if(n.length!==0)return n[0]}async queryDocs(e={},t){if(ee.debug("queryDocs",e),this._isClosed)throw new v;let n=Ee(t);return await this.replicaDriver.docDriver.queryDocs({...e,formats:n.map(s=>s.id)})}async queryPaths(e={},t){let n=await this.queryDocs(e,t),s=new Set(n.map(({path:a})=>a));return Array.from(s).sort()}async queryAuthors(e={},t){let n=await this.queryDocs(e,t),s=new Set(n.map(({author:a})=>a));return Array.from(s).sort()}async set(e,t,n=se){if(te.debug("set",t),this._isClosed)throw new v;te.debug("...deciding timestamp: getting latest doc at the same path (from any author)");let s=await this.getLatestDocAtPath(t.path),a;typeof t.timestamp=="number"?a=t.timestamp:s===void 0?a=Br():a=Math.max(Br(),s.timestamp+1),te.debug("...generating doc");let i;if(s){let l=n.removeExtraFields(s);w(l)||(i=l.doc)}let o=await n.generateDocument({keypair:e,input:{...t,format:n.id},share:this.share,timestamp:a,prevLatestDoc:i,config:this.formatsConfig[n.id]});if(w(o))return{kind:"failure",reason:"invalid_document",err:o};if(te.debug("...signature =",o.doc.signature),o.attachment){let l=await this.replicaDriver.attachmentDriver.stage(n.id,o.attachment);if(w(l))return{kind:"failure",reason:"invalid_document",err:l};let h=await n.updateAttachmentFields(e,o.doc,l.size,l.hash,this.formatsConfig[n.id]);if(w(h))return await l.reject(),{kind:"failure",reason:"invalid_document",err:h};te.debug("...ingesting attachment"),te.debug("-----------------------"),await l.commit(),await this.eventWriter.write({kind:"attachment_ingest",doc:h,hash:l.hash,size:l.size,sourceId:"local"}),te.debug("...done ingesting attachment"),te.debug("...ingesting"),te.debug("-----------------------");let d=await this.ingest(n,h,"local");return te.debug("...done ingesting"),te.debug("...set is done."),d}te.debug("...ingesting"),te.debug("-----------------------");let c=await this.ingest(n,o.doc,"local");return te.debug("...done ingesting"),te.debug("...set is done."),c}async ingest(e,t,n){if(Z.debug("ingest",t),this._isClosed)throw new v;Z.debug("...removing extra fields");let s=e.removeExtraFields(t);if(w(s))return{kind:"failure",reason:"invalid_document",err:s};t=s.doc;let a=s.extras;Object.keys(a).length>0&&Z.debug(`...extra fields found: ${Va(a)}`);let i=await e.checkDocumentIsValid(t);if(w(i))return{kind:"failure",reason:"invalid_document",err:i};let o=T();return await this.ingestLockStream.run(async()=>{Z.debug(" >> ingest: start of protected region"),Z.debug("  > getting other history docs at the same path by any author");let c=await this.getAllDocsAtPath(t.path,[e]);Z.debug(`  > ...got ${c.length}`),Z.debug("  > getting prevLatest and prevSameAuthor");let l=c[0]??null,h=c.filter(g=>g.author===t.author)[0]??null;Z.debug("  > checking if new doc is latest at this path"),c.push(t),c.sort(ts);let d=c[0]===t;if(Z.debug(`  > ...isLatest: ${d}`),!d&&h!==null){Z.debug("  > new doc is not latest and there is another one from the same author...");let g=ts(t,h);if(g===1){Z.debug("  > new doc is GT prevSameAuthor, so it is obsolete"),o.resolve({kind:"nothing_happened",reason:"obsolete_from_same_author",doc:t});return}if(g===0){Z.debug("  > new doc is EQ prevSameAuthor, so it is redundant (already_had_it)"),o.resolve({kind:"nothing_happened",reason:"already_had_it",doc:t});return}}Z.debug("  > upserting into ReplicaDriver...");let u=await this.replicaDriver.docDriver.upsert(t);Z.debug("  > ...done upserting into ReplicaDriver"),Z.debug("  > ...getting ReplicaDriver maxLocalIndex...");let p=await this.replicaDriver.docDriver.getMaxLocalIndex();Z.debug(" >> ingest: end of protected region, returning a WriteEvent from the lock");let f={kind:"success",maxLocalIndex:p,doc:u,docIsLatest:d,prevDocFromSameAuthor:h,prevLatestDoc:l,sourceId:n};if(o.resolve(f),await this.eventWriter.write(f),u.deleteAfter){let g=`${u.path}|${u.author}`,A=this.expireEventTimeouts.get(g);A&&clearTimeout(A);let E=u.deleteAfter/1e3-Date.now();this.expireEventTimeouts.set(g,setTimeout(()=>{this.eventWriter.write({kind:"expire",doc:u})},E))}}),o}async overwriteAllDocsByAuthor(e,t){let n=Rr(t);if(ee.debug(`overwriteAllDocsByAuthor("${e.address}")`),this._isClosed)throw new v;let s=await this.queryDocs({filter:{author:e.address},historyMode:"all"},[n]);ee.debug(`    ...found ${s.length} docs to overwrite`);let a=0,i=0;for(let o of s){let c=await this.wipeDocument(e,o,Rr(t));if(w(c))return c;a+=1}return ee.debug(`    ...done; ${a} overwritten to be empty; ${i} were already empty; out of total ${s.length} docs`),a}async wipeDocAtPath(e,t,n=se){let s=await this.getLatestDocAtPath(t,n);return s?this.wipeDocument(e,s,n):new m("No document exists at that path")}async wipeDocument(e,t,n){let s={...t,timestamp:Math.max(t.timestamp+1,Date.now()*1e3),author:e.address},a=await n.wipeDocument(e,s,this.formatsConfig[n.id]);if(w(a))return{kind:"failure",err:a,reason:"invalid_document"};let i=await this.ingest(n,a,"local");if(i.kind==="success"){let o=n.getAttachmentInfo(t);if(!w(o)){let c=await this.replicaDriver.attachmentDriver.erase(n.id,o.hash);w(c)||await this.eventWriter.write({kind:"attachment_prune",format:n.id,hash:o.hash})}}return i}async pruneExpiredDocsAndAttachments(e=Xe){let t=await this.replicaDriver.docDriver.eraseExpiredDocs();for(let i of t)await this.eventWriter.write({kind:"expire",doc:i});let n=ve(e),s={};await this.getQueryStream({historyMode:"all",orderBy:"localIndex ASC"},"existing",e).pipeTo(new WritableStream({write(i){if(i.kind==="existing"){let o=n[i.doc.format],c=o.getAttachmentInfo(i.doc);if(!w(c)){let l=s[o.id];l?l.add(c.hash):s[o.id]=new Set([c.hash])}}}}));let a=await this.replicaDriver.attachmentDriver.filter(s);for(let i of a)await this.eventWriter.write({kind:"attachment_prune",format:i.format,hash:i.hash})}getEventStream(e="*"){return this.eventMultiStream.getReadableStream(e)}getQueryStream(e={},t,n){let s=this.queryDocs.bind(this),a=this.getEventStream.bind(this);return new ReadableStream({async start(i){if(t==="existing"||t==="everything"){let l=await s(e,n);for(let h of l)i.enqueue({kind:"existing",doc:h})}if(i.enqueue({kind:"processed_all_existing"}),t==="existing"){i.close();return}let c=a().getReader();for(;;){let{done:l,value:h}=await c.read();if(l)return;if(h.kind==="expire"||h.kind==="success"){if(e.filter&&Me(h.doc,e.filter)){i.enqueue(h);continue}i.enqueue(h);continue}h.kind==="didClose"&&i.close()}}})}onEvent(e){return this.callbackSink.onWrite(e)}async ingestAttachment(e,t,n,s){if(this._isClosed)throw new v;let a=e.removeExtraFields(t);if(w(a))return Promise.resolve(a);t=a.doc;let i=await e.checkDocumentIsValid(t);if(w(i))return Promise.resolve(i);let o=await this.getAttachment(t,e);if(o&&!w(o))return!1;let c=e.getAttachmentInfo(t);if(w(c))return Promise.resolve(c);let l=await this.replicaDriver.attachmentDriver.stage(t.format,n);return w(l)?l:l.hash!==c.hash?(await l.reject(),new m("Attachment's hash did not match the document's")):l.size!==c.size?(await l.reject(),new m("Attachment's size did not match the document's")):(await l.commit(),await this.eventWriter.write({kind:"attachment_ingest",doc:t,hash:l.hash,size:l.size,sourceId:s}),!0)}getAttachment(e,t=se){if(e.deleteAfter&&e.deleteAfter<Date.now()*1e3)return Promise.resolve(new m("This document has expired"));let n=t.getAttachmentInfo(e);return w(n)?Promise.resolve(n):this.replicaDriver.attachmentDriver.getAttachment(e.format,n.hash)}addAttachments(e,t){let n=Ee(t),s={};for(let i of n)s[i.id]=i;let a=e.map(i=>new Promise(o=>{let l=s[i.format].getAttachmentInfo(i);if(!w(l))this.replicaDriver.attachmentDriver.getAttachment(i.format,l.hash).then(h=>{o({...i,attachment:h})});else return o({...i,attachment:l})}));return Promise.all(a)}};var rs=class extends ir{constructor(e){super({driver:e.driver,config:{"es.5":{shareSecret:e.shareSecret}}})}};var je=new C("replica-cache","green");function ns({_localIndex:r}){return r}function ss(r,e){let t=[];for(let n of e)if(!(r.orderBy==="path ASC"&&r.startAfter!==void 0&&r.startAfter.path!==void 0&&n.path<=r.startAfter.path)&&!(r.orderBy==="path DESC"&&r.startAfter!==void 0&&r.startAfter.path!==void 0&&n.path>=r.startAfter.path)&&!(r.orderBy==="localIndex ASC"&&r.startAfter!==void 0&&r.startAfter.localIndex!==void 0&&(n._localIndex||0)<=r.startAfter.localIndex)&&!(r.orderBy==="localIndex DESC"&&r.startAfter!==void 0&&r.startAfter.localIndex!==void 0&&(n._localIndex||0)>=r.startAfter.localIndex)&&(t.push(n),r.limit!==void 0&&t.length>=r.limit))break;return t}var as=class{constructor(e,t,n){this.version=0;this.docCache=new Map;this.onCacheUpdatedCallbacks=new Set;this.closed=!1;this.onFireCacheUpdatedsWrapper=e=>e();this.attachmentCache=new Map;this.replica=e,this.timeToLive=t||1e3,n&&(this.onFireCacheUpdatedsWrapper=n);let s=this.onReplicaEvent.bind(this),a=this.close.bind(this),i=this.isClosed.bind(this);this.replica.getEventStream("*").pipeTo(new WritableStream({async write(o){o.kind==="attachment_ingest"||o.kind==="success"||o.kind==="expire"?await s(o):o.kind==="willClose"&&!i()&&await a()}})).catch(()=>{})}async close(){if(this.closed)throw new ye;this.closed=!0,await Promise.all(Array.from(this.docCache.values()).map(e=>e.close())),this.docCache.clear(),this.onCacheUpdatedCallbacks.clear()}isClosed(){return this.closed}getAllDocs(e){return this.queryDocs({historyMode:"all",orderBy:"path DESC"},e)}getLatestDocs(e){return this.queryDocs({historyMode:"latest",orderBy:"path DESC"},e)}getAllDocsAtPath(e,t){return this.queryDocs({historyMode:"all",orderBy:"path DESC",filter:{path:e}},t)}getLatestDocAtPath(e,t){let n=this.queryDocs({historyMode:"latest",orderBy:"path DESC",filter:{path:e}},t?[t]:void 0);if(n.length!==0)return n[0]}queryDocs(e={},t){if(this.closed)throw new ye;if(this.replica.isClosed())throw new v;let s={...e,formats:(t||Xe).map(f=>f.id)},a=at(s);if(a.willMatch==="nothing")return[];let i=kt(a.query),o=this.docCache.get(i);if(o)return Date.now()>o.expires&&this.replica.queryDocs(e,t).then(f=>{let g=f.map(ns).sort(),A=o.docs.map(ns).sort();_e(g,A)||(this.docCache.set(i,{stream:o.stream,close:o.close,docs:f,expires:Date.now()+this.timeToLive}),je.debug("Updated cache because result expired."),this.fireOnCacheUpdateds())}),o.docs;let c=this.replica.getQueryStream(e,"new",t),l=new et,h=l.onWrite(f=>{(f.kind==="existing"||f.kind==="success")&&(je.debug({doc:f.doc.path,queryString:i}),this._updateCache(i,f.doc))}),d=new WritableStream(l),u=new AbortController;c.pipeTo(d,{signal:u.signal});let p=()=>{h()};return this.docCache.set(i,{stream:c,docs:[],expires:Date.now()+this.timeToLive,close:p}),this.replica.queryDocs(s).then(f=>{this.docCache.set(i,{stream:c,close:p,docs:f,expires:Date.now()+this.timeToLive}),je.debug("Updated cache with a new entry."),this.fireOnCacheUpdateds()}),[]}queryPaths(e={},t){let n=this.queryDocs(e,t),s=new Set(n.map(({path:a})=>a));return Array.from(s).sort()}queryAuthors(e={},t){let n=this.queryDocs(e,t),s=new Set(n.map(({author:a})=>a));return Array.from(s).sort()}_updateCache(e,t){let n=this.docCache.get(e);if(!n)return;let s=JSON.parse(e),a=()=>{let p=[...n.docs,t];this.docCache.set(e,{...n,docs:ss(s,p)}),this.fireOnCacheUpdateds()},i=({exact:p})=>{let f=n.docs.map(g=>p&&g.path===t.path&&g.author===t.author||!p&&g.path===t.path?t:g);this.docCache.set(e,{...n,docs:ss(s,f)}),this.fireOnCacheUpdateds()},o=n.docs.filter(p=>p.path===t.path),c=n.docs.filter(p=>p.path===t.path&&p.author===t.author);if(o.length===0){(s.filter&&Me(t,s.filter)||!s.filter)&&(je.debug("Updated cache after appending a doc to a entry with matching filter."),a());return}if((s.historyMode||"latest")==="all"){if(c.length===0){je.debug("Updated cache after appending a version of a doc to a historyMode: all query."),a();return}je.debug("Updated cache after replacing a version of a doc in a historyMode: all query."),i({exact:!0});return}let h=o[0],d=t.author!==h?.author||!we(t,h),u=t.timestamp>h.timestamp;if(d&&u){je.debug("Updated cache after replacing a doc with its latest version."),i({exact:!1});return}}fireOnCacheUpdateds(){this.version++,this.onFireCacheUpdatedsWrapper(()=>{this.onCacheUpdatedCallbacks.forEach(e=>{e()})})}onCacheUpdated(e){if(this.closed)throw new ye;if(this.replica.isClosed())throw new v;return this.onCacheUpdatedCallbacks.add(e),()=>{this.onCacheUpdatedCallbacks.delete(e)}}set(e,t,n){if(this.closed)throw new ye;return this.replica.set(e,t,n)}overwriteAllDocsByAuthor(e,t){if(this.closed)throw new ye;if(this.replica.isClosed())throw new v;return this.replica.overwriteAllDocsByAuthor(e,t)}wipeDocAtPath(e,t,n=se){if(this.closed)throw new ye;return this.replica.wipeDocAtPath(e,t,n)}async onReplicaEvent(e){let t=`${e.doc.path}|${e.doc.author}`,n=this.attachmentCache.get(t);if(!n)return;let s=await this.replica.getAttachment(e.doc,n.format);this.attachmentCache.set(t,{expires:Date.now()+this.timeToLive,attachment:s,format:n.format}),this.fireOnCacheUpdateds()}getAttachment(e,t=se){if(this.closed)throw new ye;if(this.replica.isClosed())throw new v;let n=t.getAttachmentInfo(e);if(w(n))return n;let s=`${e.path}|${e.author}`,a=this.attachmentCache.get(s);if(a)return Date.now()>a.expires&&this.replica.getAttachment(e,t).then(i=>{this.attachmentCache.set(s,{expires:Date.now()+this.timeToLive,attachment:i,format:t}),this.fireOnCacheUpdateds()}),e.deleteAfter&&Date.now()*1e3>e.deleteAfter?new m("This document has expired"):a.attachment;this.attachmentCache.set(s,{attachment:void 0,expires:Date.now()+this.timeToLive,format:t}),this.replica.getAttachment(e,t).then(i=>{this.attachmentCache.set(s,{expires:Date.now()+this.timeToLive,attachment:i,format:t}),this.fireOnCacheUpdateds()})}addAttachments(e,t){let n=[],s=ve(t);for(let a of e){let i=this.getAttachment(a,s[a.format]);n.push({...a,attachment:i})}return n}};var ue=new C("storage driver async memory","yellow");function is(r){return`${r.path}|${r.author}`}function os(r,e){return Be([r.path,r.timestamp,r.signature],[e.path,e.timestamp,r.signature],["ASC","DESC","ASC"])}function Ka(r,e){return Be([r.path,r.timestamp,r.signature],[e.path,e.timestamp,r.signature],["DESC","DESC","ASC"])}var ot=class{constructor(e){this._maxLocalIndex=-1;this._isClosed=!1;this._configKv={};this.docByPathAndAuthor=new Map;this.docsByPathNewestFirst=new Map;this.latestDocsByPath=new Map;ue.debug("constructor");let t=z(e);if(w(t))throw t;this.share=e}isClosed(){return this._isClosed}close(e){if(ue.debug("close"),this._isClosed)throw new v;return e&&(ue.debug("...close: and erase"),this._configKv={},this._maxLocalIndex=-1,this.docsByPathNewestFirst.clear(),this.docByPathAndAuthor.clear()),this._isClosed=!0,ue.debug("...close is done."),Promise.resolve()}async getConfig(e){if(this._isClosed)throw new v;return this._configKv[e]}async setConfig(e,t){if(this._isClosed)throw new v;this._configKv[e]=t}async listConfigKeys(){if(this._isClosed)throw new v;return es(Object.keys(this._configKv))}async deleteConfig(e){if(this._isClosed)throw new v;let t=e in this._configKv;return delete this._configKv[e],t}getMaxLocalIndex(){if(this._isClosed)throw new v;return ue.debug(`getMaxLocalIndex(): it's ${this._maxLocalIndex}`),Promise.resolve(this._maxLocalIndex)}async _getAllDocs(){if(this._isClosed)throw new v;return[...this.docByPathAndAuthor.values()]}async _getLatestDocs(){if(this._isClosed)throw new v;return Array.from(this.latestDocsByPath.values())}async queryDocs(e){if(ue.debug("queryDocs",e),this._isClosed)throw new v;let{query:t,willMatch:n}=at(e);if(ue.debug(`    cleanUpQuery.  willMatch = ${n}`),n==="nothing")return[];if(t.historyMode==="latest"&&t.filter?.path){let o=this.latestDocsByPath.get(t.filter.path);return o&&o.deleteAfter&&o.deleteAfter<Date.now()*1e3?[]:o?[o]:[]}if(t.historyMode==="all"&&t.filter?.path){let o=this.docsByPathNewestFirst.get(t.filter.path);if(o){let c=[];for(let l of o)(l.deleteAfter===null||l.deleteAfter===void 0)&&c.push(l),l.deleteAfter&&l.deleteAfter>Date.now()*1e3&&c.push(l);return c}return[]}ue.debug(`    getting docs; historyMode = ${t.historyMode}`);let s=t.historyMode==="all"?await this._getAllDocs():await this._getLatestDocs(),a=[];ue.debug("    filtering docs");let i=Date.now()*1e3;for(let o of s)t.orderBy==="path ASC"&&t.startAfter!==void 0&&t.startAfter.path!==void 0&&o.path<=t.startAfter.path||t.orderBy==="path DESC"&&t.startAfter!==void 0&&t.startAfter.path!==void 0&&o.path>=t.startAfter.path||t.orderBy==="localIndex ASC"&&t.startAfter!==void 0&&t.startAfter.localIndex!==void 0&&(o._localIndex??0)<=t.startAfter.localIndex||t.orderBy==="localIndex DESC"&&t.startAfter!==void 0&&t.startAfter.localIndex!==void 0&&(o._localIndex??0)>=t.startAfter.localIndex||o.deleteAfter&&o.deleteAfter<i||t.filter&&!Me(o,t.filter)||a.push(o);if(ue.debug(`    ordering docs: ${t.orderBy}`),t.orderBy==="path ASC")a.sort(os);else if(t.orderBy==="path DESC")a.sort(Ka);else if(t.orderBy==="localIndex ASC")a.sort(it("_localIndex","ASC"));else if(t.orderBy==="localIndex DESC")a.sort(it("_localIndex","DESC"));else if(t.orderBy)throw new m("unrecognized query orderBy: "+JSON.stringify(t.orderBy));return t.limit!==void 0&&s.length>=t.limit?a.slice(0,t.limit):(ue.debug(`    queryDocs is done: found ${a.length} docs.`),a)}upsert(e){if(this._isClosed)throw new v;e={...e},this._maxLocalIndex+=1,e._localIndex=this._maxLocalIndex,Object.freeze(e),ue.debug("upsert",e),this.docByPathAndAuthor.set(is(e),e);let t=this.docsByPathNewestFirst.get(e.path)??[];t=t.filter(s=>s.author!==e.author),t.push(e),t.sort(os),this.docsByPathNewestFirst.set(e.path,t);let n=t[0];return this.latestDocsByPath.set(e.path,n),Promise.resolve(e)}eraseExpiredDocs(){let e=[];for(let[,t]of this.docByPathAndAuthor)Zn(t)&&e.push(t);for(let t of e)this.docsByPathNewestFirst.delete(t.path),this.latestDocsByPath.delete(t.path),this.docByPathAndAuthor.delete(is(t));return Promise.resolve(e)}};async function or(r){let e=new Uint8Array;return await r.pipeTo(new WritableStream({write(t){let n=new Uint8Array(e.length+t.length);n.set(e),n.set(t,e.length),e=n}})),e}var cr=class{constructor(){this.stagingMap=new Map;this.attachmentMap=new Map;this.closed=!1}getKey(e,t){return`${e}___${t}`}getAttachment(e,t){if(this.closed)throw new v;let n=this.getKey(e,t),s=this.attachmentMap.get(n);return s?Promise.resolve({bytes:async()=>new Uint8Array(await s.arrayBuffer()),stream:()=>Promise.resolve(s.stream())}):Promise.resolve(void 0)}async stage(e,t){if(this.closed)throw new v;let n=t instanceof Uint8Array?t:await or(t),s=await L.sha256base32(n),a=new Blob([n]),i=this.getKey(e,s);return this.stagingMap.set(i,a),Promise.resolve({hash:s,size:n.byteLength,commit:()=>(this.attachmentMap.set(i,a),this.stagingMap.delete(i),Promise.resolve()),reject:()=>(this.stagingMap.delete(i),Promise.resolve())})}erase(e,t){if(this.closed)throw new v;let n=this.getKey(e,t);return this.attachmentMap.has(n)?(this.attachmentMap.delete(n),Promise.resolve(!0)):Promise.resolve(new m("No attachment with that signature found."))}wipe(){if(this.closed)throw new v;return this.attachmentMap.clear(),Promise.resolve()}async filter(e){if(this.closed)throw new v;let t=[];for(let n of this.attachmentMap.keys()){let[s,a]=n.split("___"),i=e[s];i&&!i.has(a)&&await this.erase(s,a)&&t.push({format:s,hash:a})}return t}clearStaging(){if(this.closed)throw new v;return this.stagingMap.clear(),Promise.resolve()}isClosed(){return this.closed}async close(e){if(this.closed)throw new v;e&&await this.wipe(),this.closed=!0}};var cs=class{constructor(e){this.docDriver=new ot(e),this.attachmentDriver=new cr}};var qa="earthstar",lr="current_author",St="shares",Dt="share_secrets",xt="servers",ls=class{constructor(e){this.storage=localStorage;this.authorChangedCbs=new Set;this.sharesChangedCbs=new Set;this.shareSecretsChangedCbs=new Set;this.serversChangedCbs=new Set;this.namespace=e?.namespace,e?.sessionOnly&&(this.storage=sessionStorage),addEventListener("storage",t=>{switch(t.key){case j(lr,this.namespace):{this.fireAuthorEvent();break}case j(St,this.namespace):{this.fireSharesEvent();break}case j(Dt,this.namespace):{this.fireSecretsEvent();break}case j(xt,this.namespace):{this.fireServersEvent();break}}})}get author(){let e=j(lr,this.namespace);return ur(this.storage,e,Wa)||null}set author(e){let t=j(lr,this.namespace);this.storage.setItem(t,JSON.stringify(e)),this.fireAuthorEvent()}get shares(){let e=j(St,this.namespace);return ur(this.storage,e,ja)||[]}addShare(e){if(w(z(e)))return new m("Not a valid share");let t=j(St,this.namespace),n=new Set([...this.shares,e]),s=Array.from(n);return this.storage.setItem(t,JSON.stringify(s)),this.fireSharesEvent(),s}removeShare(e){let t=this.shares,n=t.findIndex(a=>a===e);if(n===-1)return new m("That share is not known yet");t.splice(n,1);let s=j(St,this.namespace);return this.storage.setItem(s,JSON.stringify(t)),this.fireSharesEvent(),t}get shareSecrets(){let e=j(Dt,this.namespace);return ur(this.storage,e,Qa)||{}}async addSecret(e,t){if(!this.shares.find(i=>e===i))return new m("This share is not yet known.");if(w(await L.checkKeypairIsValid({shareAddress:e,secret:t})))return new m("Not the right secret for this share.");let s=j(Dt,this.namespace),a={...this.shareSecrets,[e]:t};return this.storage.setItem(s,JSON.stringify(a)),this.fireSecretsEvent(),a}removeSecret(e){let t=this.shareSecrets;if(!t[e])return new m("Unknown share");let s=j(Dt,this.namespace),a={...t};return delete a[e],this.storage.setItem(s,JSON.stringify(a)),this.fireSecretsEvent(),a}get servers(){let e=j(xt,this.namespace);return ur(this.storage,e,$a)||[]}addServer(e){try{let t=new URL(e),n=new Set([...this.servers,t.toString()]),s=Array.from(n),a=j(xt,this.namespace);return this.storage.setItem(a,JSON.stringify(s)),this.fireServersEvent(),s}catch{return new m("Not a valid URL.")}}removeServer(e){try{let t=new URL(e),n=this.servers,s=n.findIndex(i=>i===t.toString());if(s===-1)return new m("That server is not known yet");n.splice(s,1);let a=j(xt,this.namespace);return this.storage.setItem(a,JSON.stringify(n)),this.fireServersEvent(),n}catch{return new m("Not a valid URL")}}clear(){let e=j(lr,this.namespace);this.storage.setItem(e,JSON.stringify(null));let t=j(St,this.namespace);this.storage.setItem(t,JSON.stringify([]));let n=j(Dt,this.namespace);this.storage.setItem(n,JSON.stringify({}));let s=j(xt,this.namespace);this.storage.setItem(s,JSON.stringify([])),this.fireAuthorEvent(),this.fireSharesEvent(),this.fireSecretsEvent(),this.fireServersEvent()}onAuthorChanged(e){return this.authorChangedCbs.add(e),()=>{this.authorChangedCbs.delete(e)}}onSharesChanged(e){return this.sharesChangedCbs.add(e),()=>{this.sharesChangedCbs.delete(e)}}onShareSecretsChanged(e){return this.shareSecretsChangedCbs.add(e),()=>{this.shareSecretsChangedCbs.delete(e)}}onServersChanged(e){return this.serversChangedCbs.add(e),()=>{this.serversChangedCbs.delete(e)}}getPeer({sync:e,onCreateReplica:t}){let n=new st,s=this.shares;for(let l of s){let h=t(l,this.shareSecrets[l]);n.addReplica(h)}let a=this.onSharesChanged(async l=>{let h=n.replicas(),d=n.shares();for(let u of h)l.includes(u.share)||(n.removeReplica(u),await u.close(!1));for(let u of l)if(!d.includes(u)){let p=t(u,this.shareSecrets[u]);n.addReplica(p)}}),i=this.onShareSecretsChanged(async l=>{let h=n.shares(),d=Object.keys(l);for(let u of h)if(!d.includes(u)){let p=n.getReplica(u);p&&(n.removeReplica(p),p.close(!1));let f=t(u);n.addReplica(f)}for(let u of d){let p=n.getReplica(u);if(p?.formatsConfig["es.5"]&&p.formatsConfig["es.5"].shareSecret)continue;await p?.close(!1),n.removeReplicaByShare(u);let f=t(u,l[u]);n.addReplica(f)}});if(e)for(let l of this.servers)n.sync(l,e==="continuous");let o=this.onServersChanged(l=>{if(e){let h=n.getSyncers();for(let[d,{description:u,syncer:p}]of h)l.includes(u)||p.cancel();for(let d of l)n.sync(d,e==="continuous")}});return{peer:n,unsubscribeFromSettings:()=>{a(),i(),o()}}}fireAuthorEvent(){let e=this.author;for(let t of this.authorChangedCbs)t(e)}fireSharesEvent(){let e=this.shares;for(let t of this.sharesChangedCbs)t(e)}fireSecretsEvent(){let e=this.shareSecrets;for(let t of this.shareSecretsChangedCbs)t(e)}fireServersEvent(){let e=this.servers;for(let t of this.serversChangedCbs)t(e)}};function j(r,e){return`${qa}:${e?`${e}:`:""}${r}`}function ur(r,e,t){let n=r.getItem(e);if(n!==null)try{let s=JSON.parse(n);return t(s)?s:void 0}catch{return}}function us(r){return!(r==null||typeof r!="object")}function Wa(r){return!(!us(r)||Object.keys(r).length!==2||!("address"in r)||!("secret"in r))}function ja(r){return!(!Array.isArray(r)||r.some(e=>typeof e!="string")||r.some(e=>w(z(e))))}function Qa(r){if(!us(r))return!1;for(let e in r){let t=r[e];if(typeof t!="string"||w(L.checkKeypairIsValid({shareAddress:e,secret:t})))return!1}return!0}function $a(r){if(!Array.isArray(r)||r.some(e=>typeof e!="string"))return!1;for(let e of r)try{new URL(e)}catch{return!1}return!0}var ke=new C("storage driver localStorage","gold");function Ha(r){return typeof r!="object"?!1:"byPathAndAuthor"in r&&"byPathNewestFirst"in r}var Qr=class extends ot{constructor(t,n){super(t);ke.debug("constructor"),this._localStorageKeyConfig=`earthstar:config:${t}${n?`:${n}`:""}`,this._localStorageKeyDocs=`earthstar:documents:${t}${n?`:${n}`:""}`;let s=localStorage.getItem(this._localStorageKeyDocs);if(s!==null){ke.debug("...constructor: loading data from localStorage");let a=JSON.parse(s);if(!Ha(a)){console.warn(`localStorage data could not be parsed for share ${t}`);return}this.docByPathAndAuthor=new Map(Object.entries(a.byPathAndAuthor)),this.docsByPathNewestFirst=new Map(Object.entries(a.byPathNewestFirst)),this.latestDocsByPath=new Map(Object.entries(a.latestDocsByPath));let i=Array.from(this.docByPathAndAuthor.values()).map(o=>o._localIndex);this._maxLocalIndex=Math.max(...i)}else ke.debug("...constructor: there was no existing data in localStorage");ke.debug("...constructor is done.")}close(t){if(ke.debug("close"),this._isClosed)throw new v;if(t){ke.debug("...close: and erase"),this._configKv={},this._maxLocalIndex=-1,this.docsByPathNewestFirst.clear(),this.docByPathAndAuthor.clear(),ke.debug("...close: erasing localStorage"),localStorage.removeItem(this._localStorageKeyDocs);for(let n of this._listConfigKeysSync())this._deleteConfigSync(n);ke.debug("...close: erasing is done")}return this._isClosed=!0,ke.debug("...close is done."),Promise.resolve()}_getConfigSync(t){if(this._isClosed)throw new v;t=`${this._localStorageKeyConfig}:${t}`;let n=localStorage.getItem(t);return n===null?void 0:n}_setConfigSync(t,n){if(this._isClosed)throw new v;t=`${this._localStorageKeyConfig}:${t}`,localStorage.setItem(t,n)}_listConfigKeysSync(){if(this._isClosed)throw new v;let t=Object.keys(localStorage).filter(n=>n.startsWith(this._localStorageKeyConfig+":")).map(n=>n.slice(this._localStorageKeyConfig.length+1));return t.sort(),t}_deleteConfigSync(t){if(this._isClosed)throw new v;let n=this._getConfigSync(t);return t=`${this._localStorageKeyConfig}:${t}`,localStorage.removeItem(t),n!==void 0}async getConfig(t){return this._getConfigSync(t)}async setConfig(t,n){return this._setConfigSync(t,n)}async listConfigKeys(){return this._listConfigKeysSync()}async deleteConfig(t){return this._deleteConfigSync(t)}async upsert(t){if(this._isClosed)throw new v;let n=await super.upsert(t),s={byPathAndAuthor:Object.fromEntries(this.docByPathAndAuthor),byPathNewestFirst:Object.fromEntries(this.docsByPathNewestFirst),latestDocsByPath:Object.fromEntries(this.latestDocsByPath)};return localStorage.setItem(this._localStorageKeyDocs,JSON.stringify(s)),n}};var Qe=new C("replica driver indexeddb","gold");function za(r,e){return Be([r.path,r.timestamp,r.signature],[e.path,e.timestamp,r.signature],["ASC","DESC","ASC"])}function Ga(r,e){return Be([r.path,r.timestamp,r.signature],[e.path,e.timestamp,r.signature],["DESC","DESC","ASC"])}var ae="docs",me="config",Et=class{constructor(e,t){this.db=T();this.gotInitialMaxLocalIndex=T();this.localMaxLocalIndex=-1;this.closed=!1;let n=z(e);if(w(n))throw n;if(this.share=e,Qe.debug("constructor"),!window.indexedDB)throw new R("IndexedDB is not supported by this runtime.");let s=window.indexedDB.open(`earthstar:share_docs:${this.share}${t?`/${t}`:""}`,1);s.onerror=()=>{throw Qe.error(`Could not open IndexedDB for ${this.share}'s attachments.`),Qe.error(s.error),new R(`Could not open IndexedDB for ${this.share}'s attachments.`)},s.onupgradeneeded=function(){let a=s.result,i=a.createObjectStore(ae,{keyPath:["path","author"]});i.createIndex("comboIndex",["_localIndex","timestamp","path","author"],{unique:!0}),i.createIndex("pathTimestampIndex",["path","timestamp"],{unique:!1}),i.createIndex("pathAuthorIndex",["path","author"],{unique:!0}),i.createIndex("deleteAfterIndex","deleteAfter",{unique:!1}),i.createIndex("localIndexIndex","_localIndex",{unique:!0}),a.createObjectStore(me,{keyPath:"key"}).createIndex("keyIndex",["key"],{unique:!0})},s.onsuccess=()=>{this.db.resolve(s.result);let i=s.result.transaction([ae],"readonly").objectStore(ae).index("localIndexIndex").openCursor(null,"prev");i.onsuccess=()=>{i.result?this.gotInitialMaxLocalIndex.resolve(i.result.value._localIndex):this.gotInitialMaxLocalIndex.resolve(-1)}},this.gotInitialMaxLocalIndex.then(a=>{this.localMaxLocalIndex=a})}isClosed(){return this.closed}async close(e){if(this.closed)throw new v;this.closed=!0;let t=T();if(e){let s=(await this.db).transaction([ae,me],"readwrite"),a=T(),i=T(),o=s.objectStore(ae).clear().onsuccess=()=>{a.resolve()},c=s.objectStore(me).clear().onsuccess=()=>{i.resolve()};await Promise.all([o,c]),t.resolve()}else t.resolve();return(await this.db).close(),await Qt(20),t}async getMaxLocalIndex(){return await this.gotInitialMaxLocalIndex,this.localMaxLocalIndex}async queryDocs(e){let n=(await this.db).transaction([ae],"readonly").objectStore(ae),s=T(),{query:a,willMatch:i}=at(e);if(Qe.debug(`    cleanUpQuery.  willMatch = ${i}`),i==="nothing")return[];if(a.filter?.path&&a.historyMode==="latest"){let h=IDBKeyRange.bound([a.filter.path,a.filter.timestampGt||0],[a.filter.path,a.filter.timestampLt||Number.MAX_SAFE_INTEGER]),u=n.index("pathTimestampIndex").openCursor(h,"prev");u.onsuccess=()=>{u.result?.value?s.resolve([u.result.value]):s.resolve([])}}else if(a.filter?.path&&a.historyMode==="all"){let h=n.index("pathAuthorIndex"),d=IDBKeyRange.bound([a.filter.path," "],[a.filter.path,"~"]),u=h.getAll(d);u.onsuccess=()=>{u.result?s.resolve(Array.from(u.result)):s.resolve([])}}else{let h=a.startAfter?.path||a.filter?.path||a.filter?.pathStartsWith||" ",d=a.filter?.author||" ",u=a.filter?.timestamp||a.filter?.timestampGt||0,p=a.startAfter?.localIndex||0,f=a.filter?.path||"~",g=a.filter?.author||"~",A=a.filter?.timestamp||a.filter?.timestampLt||Number.MAX_SAFE_INTEGER,E=Number.MAX_SAFE_INTEGER,_=IDBKeyRange.bound([p,u,h,d],[E,A,f,g]),S=n.index("comboIndex").getAll(_);S.onsuccess=()=>{S.result?s.resolve(S.result):s.resolve([])}}let o=await s;if(a.historyMode==="latest"){let h=o.splice(0,o.length),d=new Map;for(let u of h){let p=d.get(u.path);(!p||p.timestamp<u.timestamp)&&d.set(u.path,u)}o.push(...d.values())}let c=[];Qe.debug("    filtering docs");let l=Date.now()*1e3;for(let h of o)h.deleteAfter&&h.deleteAfter<l||a.filter&&!Me(h,a.filter)||c.push(h);if(Qe.debug(`    ordering docs: ${a.orderBy}`),a.orderBy==="path ASC")c.sort(za);else if(a.orderBy==="path DESC")c.sort(Ga);else if(a.orderBy==="localIndex ASC")c.sort(it("_localIndex","ASC"));else if(a.orderBy==="localIndex DESC")c.sort(it("_localIndex","DESC"));else if(a.orderBy)throw new m("unrecognized query orderBy: "+JSON.stringify(a.orderBy));return a.limit!==void 0&&o.length>=a.limit?c.slice(0,a.limit):(Qe.debug(`    queryDocs is done: found ${c.length} docs.`),c)}async upsert(e){let t=await this.db,s=t.transaction([ae],"readwrite").objectStore(ae).index("pathAuthorIndex"),a=T(),i=s.openCursor([e.path,e.author]);if(await this.gotInitialMaxLocalIndex,this.localMaxLocalIndex+=1,e._localIndex=this.localMaxLocalIndex,i.onsuccess=()=>{if(i.result){let d=i.result.update(e);d.onsuccess=()=>{a.resolve(!!d.result)}}else a.resolve(!1)},await a)return e;let l=t.transaction([ae],"readwrite").objectStore(ae).put(e),h=T();return l.onsuccess=()=>{h.resolve()},l.onerror=()=>{throw l.error},await h,e}async eraseExpiredDocs(){let e=[],s=(await this.db).transaction([ae],"readwrite").objectStore(ae).index("deleteAfterIndex"),a=Date.now()*1e3,i=IDBKeyRange.bound(0,a),o=s.openCursor(i),c=T();return o.onsuccess=()=>{if(o.result?.value){let l=o.result.value;if(l.deleteAfter!==null&&l.deleteAfter!==void 0){e.push(l);let h=o.result.delete();h.onsuccess=()=>{o.result?.continue()}}}else c.resolve()},await c,e}async getConfig(e){let n=(await this.db).transaction([me],"readonly").objectStore(me),s=T(),a=n.get(e);return a.onsuccess=()=>{s.resolve(a.result?.value)},s}async setConfig(e,t){let s=(await this.db).transaction([me],"readwrite").objectStore(me),a=T(),i=s.put({key:e,value:t});return i.onsuccess=()=>{a.resolve()},a}async listConfigKeys(){let t=(await this.db).transaction([me],"readonly").objectStore(me),n=T(),a=t.index("keyIndex").openKeyCursor(),i=[];return a.onsuccess=()=>{a.result?(i.push(a.result.primaryKey),a.result.continue()):n.resolve(i)},n}async deleteConfig(e){let n=(await this.db).transaction([me],"readwrite").objectStore(me),s=T(),a=n.index("keyIndex"),i=IDBKeyRange.bound([e],[e]),o=a.openCursor(i);return o.onsuccess=()=>{if(o.result){let c=o.result.delete();c.onsuccess=()=>{s.resolve(!0)}}else s.resolve(!1)},s}};var ds=new C("replica driver indexeddb","gold"),ge="attachment_staging_index",ie="attachments_index",ne="attachments_bytes",Bt=class{constructor(e,t){this.db=T();this.closed=!1;if(this.share=e,!window.indexedDB)throw new R("IndexedDB is not supported by this runtime.");let n=window.indexedDB.open(`earthstar:share_attachments:${this.share}${t?`/${t}`:""}`,1);n.onerror=()=>{throw ds.error(`Could not open IndexedDB for ${this.share}'s attachments.`),ds.error(n.error),new R(`Could not open IndexedDB for ${this.share}'s attachments.`)},n.onupgradeneeded=function(){let s=n.result;s.createObjectStore(ne),s.createObjectStore(ie,{keyPath:"id"}),s.createObjectStore(ge,{keyPath:"id"})},n.onsuccess=()=>{this.db.resolve(n.result)}}getIndexKey(e,t){return`${e}___${t}`}async getAttachment(e,t){if(this.closed)throw new v;let n=T(),s=this.getIndexKey(e,t),a=await this.db,o=a.transaction([ie],"readonly").objectStore(ie).get(s),c=T();return o.onerror=()=>{c.reject()},o.onsuccess=()=>{o.result===void 0?c.reject():c.resolve(o.result.blobKey)},c.then(l=>{let d=a.transaction([ne],"readonly").objectStore(ne).get(l);d.onsuccess=()=>{let u=new Blob([d.result]);n.resolve({bytes:async()=>new Uint8Array(await u.arrayBuffer()),stream:()=>Promise.resolve(u.stream())})},d.onerror=()=>{n.resolve(void 0)}}).catch(()=>{n.resolve(void 0)}),n}async erase(e,t){if(this.closed)throw new v;let n=T(),s=this.getIndexKey(e,t),a=await this.db,o=a.transaction([ie],"readonly").objectStore(ie).get(s),c=T();return o.onerror=()=>{c.reject()},o.onsuccess=()=>{a.transaction([ie],"readwrite").objectStore(ie).delete(s),o.result===void 0?c.reject():c.resolve(o.result.blobKey)},c.then(l=>{let h=a.transaction([ne],"readwrite").objectStore(ne).delete(l);h.onsuccess=()=>{n.resolve(!0)},h.onerror=()=>{n.resolve(void 0)}}).catch(()=>{n.resolve(new m("No attachment found"))}),n}async stage(e,t){if(this.closed)throw new v;let n=await this.db,s=t instanceof Uint8Array?t:await or(t),a=await L.sha256base32(s),i=this.getIndexKey(e,a),o=`${i}___${re()}`,c=n.transaction([ne,ge],"readwrite"),l=c.objectStore(ne).put(s,o),h=c.objectStore(ge).put({id:i,blobKey:o}),d=T(),u=T();return l.onsuccess=()=>d.resolve(),h.onsuccess=()=>u.resolve(),await d,await u,{hash:a,size:s.byteLength,reject:async()=>{let p=n.transaction([ne,ge],"readwrite"),f=p.objectStore(ne).delete(o),g=p.objectStore(ge).delete(i),A=T(),E=T();f.onsuccess=()=>{A.resolve()},g.onsuccess=()=>{E.resolve()},await Promise.all([A,E])},commit:async()=>{let p=n.transaction([ie,ge],"readwrite"),f=p.objectStore(ge).delete(i),g=p.objectStore(ie).put({id:i,blobKey:o}),A=T(),E=T();f.onsuccess=()=>A.resolve(),g.onsuccess=()=>E.resolve(),await Promise.all([A,E])}}}async wipe(){if(this.closed)throw new v;let t=(await this.db).transaction([ne,ie,ge],"readwrite"),n=t.objectStore(ne).clear(),s=t.objectStore(ie).clear(),a=t.objectStore(ge).clear(),i=T(),o=T(),c=T();n.onsuccess=()=>i.resolve(),s.onsuccess=()=>o.resolve(),a.onsuccess=()=>c.resolve(),await Promise.all([i,o,c])}async clearStaging(){if(this.closed)throw new v;let t=(await this.db).transaction([ne,ge]),n=t.objectStore(ge).openCursor(),s=T();return n.onsuccess=()=>{let a=n.result;if(!a){s.resolve();return}let i=a.value.blobKey,o=t.objectStore(ne).delete(i);a.delete(),o.onsuccess=()=>{a.continue()},o.onerror=()=>{a.continue()}},s}async filter(e){if(this.closed)throw new v;let n=(await this.db).transaction([ne,ie],"readwrite"),s=50,a=[],i=[],o=T(),c=(l=null)=>{let h=n.objectStore(ie).getAll(l,s);h.onsuccess=()=>{let d=h.result;for(let u of d){let[p,f]=u.id.split("___");e[p]&&!e[p].has(f)&&(a.push({format:p,hash:f}),i.push(this.erase(p,f)))}if(d.length===s){let u=d[d.length-1],p=IDBKeyRange.lowerBound(u.id,!0);c(p)}else o.resolve()}};return c(),await o,await Promise.all(i),a}isClosed(){return this.closed}async close(e){if(this.closed)throw new v;e&&await this.wipe(),this.closed=!0,(await this.db).close(),await Qt(20)}};var $r=class{constructor(e,t){this.docDriver=new Et(e,t),this.attachmentDriver=new Bt(e,t)}};export{Bt as AttachmentDriverIndexedDB,cr as AttachmentDriverMemory,jr as Cmp,Jr as ConnectionRefusedError,L as Crypto,Rn as CryptoDriverNoble,se as DEFAULT_FORMAT,Xe as DEFAULT_FORMATS,wa as DEFAULT_LOG_LEVEL,Jn as DEFAULT_QUERY,Et as DocDriverIndexedDB,Qr as DocDriverLocalStorage,ot as DocDriverMemory,R as EarthstarError,xc as FormatEs4,Qn as FormatEs5,Le as GlobalCryptoDriver,ya as LogLevel,C as Logger,ir as MultiformatReplica,zr as NetworkError,Zr as NotImplementedError,ce as NotSupportedError,er as PartnerLocal,Gn as PartnerWebClient,st as Peer,rs as Replica,as as ReplicaCache,ye as ReplicaCacheIsClosedError,cs as ReplicaDriverMemory,$r as ReplicaDriverWeb,v as ReplicaIsClosedError,ls as SharedSettings,nt as Syncer,Gr as TimeoutError,m as ValidationError,Oa as _matchAll,Re as alphaLower,ma as alphaUpper,Vt as assembleAuthorAddress,Kt as assembleShareAddress,_t as authorAddressChars,En as authorKeyChars,Sr as authorNameChars,pe as b32chars,go as b64StringToBytes,le as base32BytesToString,Ye as base32StringToBytes,fo as bytesToString,Je as checkAuthorIsValid,Ke as checkInt,Bo as checkIsPlainObject,qt as checkLiteral,Wt as checkObj,z as checkShareIsValid,G as checkString,at as cleanUpQuery,Be as compareArrays,ar as compareBasic,Vu as compareByFn,Ku as compareByObjArrayFn,it as compareByObjKey,mo as concatBytes,kr as countChars,Ln as decodeKeypairToBytes,gt as digits,Zn as docIsExpired,Me as docMatchesFilter,Xo as encodeAuthorKeypairToStrings,ec as encodeShareKeypairToStrings,Na as escapeStringForRegex,Pu as extractTemplateVariablesFromPath,Ua as extractTemplateVariablesFromPathUsingRegex,zo as generateShareAddress,$n as getFormatIntersection,ve as getFormatLookup,Rr as getFormatWithFallback,Ee as getFormatsWithFallback,ba as getLogLevel,Mo as getLogLevels,Yn as globToQueryAndRegex,At as globToRegex,yo as identifyBufOrBytes,Lu as insertVariablesIntoTemplate,Ir as isAuthorKeypair,fa as isBuffer,pa as isBytes,Ar as isDigit,w as isErr,Pn as isObjectEmpty,To as isOnlyPrintableAscii,Ze as isPlainObject,Br as microsecondNow,hr as notErr,mt as onlyHasChars,In as parseAddress,Bn as parseAuthorAddress,yt as parseAuthorOrShareAddress,kn as parseShareAddress,Xn as parseTemplate,Ut as pathChars,ga as pathPunctuation,Ru as queryByGlob,Mu as queryByTemplate,re as randomId,wt as replaceAll,Lo as setDefaultLogLevel,ic as setGlobalCryptoDriver,Po as setLogLevel,Qt as sleep,es as sortedInPlace,xn as stringLengthInBytes,Ge as stringToBytes,Ro as updateLogLevels,Ot as workspaceAddressChars,Nt as workspaceKeyChars,Dr as workspaceNameChars};
/*! noble-ed25519 - MIT License (c) 2019 Paul Miller (paulmillr.com) */
//# sourceMappingURL=earthstar.web.v10.0.1.js.map